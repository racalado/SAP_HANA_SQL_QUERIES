SELECT A.NOTA, A.CONTA_CONT, A.INST, A.DT_FIM_AVARIA, A.DT_ENCE, A.SETOR, A.UTD, A.DESC_EPS, 
A.TIPO, A.FAMILIA, A.COD_IRREG, A.CODSIT, A.CLASSE, A.ZCGTXTNOT, A.TARIFA, A.TENSAO, A.TIPO_MED,
YY.MEDIA, YY.MES1_PER, YY.MES2_PER, YY.MES3_PER,

CAST((CASE WHEN FAMILIA = '100' THEN ENER."Energia_irr" 
WHEN FAMILIA = '200' THEN ENER."Energia_def" END) AS DECIMAL (10,2)) AS PREV_ENERGIA
,A.ZCGUNLEIT

FROM
(SELECT 

TAB.ZCGQMNUM AS NOTA,
TAB.ZCGACCOUN AS CONTA_CONT,
TAB.ZCGINSTAL AS INST,
TAB.ZCGDTFINA AS DT_FIM_AVARIA,
TAB.ZCGDTENCE AS DT_ENCE,
ZZ.SETOR,
ZZ.UTD,
CT.DESC_EPS,
TAB.ZCGUSRSTS AS TIPO,
TAB.URGRP AS FAMILIA,
TAB.URCOD AS COD_IRREG,
CAB.CODSIT,
CI.CLASSE,
TAB.ZCGTXTNOT,
ZZ.ZCGTARTYP AS TARIFA,
ZZ.TARIFART AS TENSAO,
TIPO_MED,
ZZ.ZCGUNLEIT

FROM "CLB_CCS_ICC"."ZCT_DS_TAB004" TAB

LEFT JOIN "CLP124051"."PLANILHAO_NOTA_CI" CI
ON TAB.ZCGQMNUM = CI.NOTA

LEFT JOIN "CLP124051"."CENTRO_TRAB_NEW" CT
ON TAB.ZCGCTTRAB_COD = CT.COD_CENTRO_TRABALHO

LEFT JOIN "NEO_PEC"."neo.pec.data::MODEL.TABLES.ZCT_DS_CABECCD" CAB
ON TAB.ZCGQMNUM = CAB.QMNUM


LEFT JOIN (
SELECT *
FROM 
(SELECT ZCGINSTAL AS INSTA, MAX(ZCGDTLIGA) AS DTLIGA FROM "CLP124051"."PLANILHAO_CLIENTE"
--WHERE ZCGINSTAL = '0001675559'
GROUP BY ZCGINSTAL)
LEFT JOIN "CLP124051"."PLANILHAO_CLIENTE"
ON ZCGDTLIGA = DTLIGA AND ZCGINSTAL = INSTA
--WHERE ZCGINSTAL = '0001675559'
) ZZ
ON TAB.ZCGINSTAL = ZZ.ZCGINSTAL


WHERE ZCGTPNOTA = 'CI' AND ZCGUSRSTS IN ('CRRE','VREL') AND CI.CODSIT IN ('11','12','30','31','32','50') and VERSAO_ATUAL = 'X'

AND CI.ERDAT = '1900-01-01') A

LEFT JOIN "CLP124051"."ENERGIA_NOTAS_FIM_AVARIA" ENER
ON A.NOTA = ENER.NOTA




LEFT JOIN 
(SELECT NOTA, INSTALACAO, MEDIA, MES1_PER, MES2_PER, MES3_PER
FROM
(
SELECT  NOTA, DATAC, INSTALACAO, A3, A2, A1 , MEDIA, P1,P2,P3 ,QTD_POS, 
P1-MEDIA AG1 , P2-MEDIA AG2 , P3-MEDIA AG, CAST( CASE WHEN P1>0 AND MEDIA>0 THEN (P1/MEDIA-1) ELSE 0 END AS DECIMAL (10,2)) AS MES1_PER,
CAST(CASE WHEN P2>0 AND MEDIA>0 THEN (P2/MEDIA-1) ELSE 0 END AS DECIMAL (10,2)) AS MES2_PER, CAST(CASE WHEN P3>0 AND MEDIA>0 THEN (P3/MEDIA-1) ELSE 0 END AS DECIMAL (10,2)) AS MES3_PER
FROM ( SELECT  NOTA, DATAC, INSTALACAO, A3, A2, A1 , 
CAST(CASE WHEN ( NUM = 0 OR NUM IS NULL) THEN 0 ELSE SOMA/NUM END AS DECIMAL(20,0)) MEDIA,
P1,P2,P3, QTD_POS FROM (
SELECT NOTA.ZCGQMNUM NOTA, ZCGDTFINA DATAC, ANLAGE2 INSTALACAO,
SUM(CASE WHEN DAYS_BETWEEN(BIS2,ZCGDTFINA) BETWEEN 61 AND 90 THEN WERT2 ELSE 0 END) A3, 
SUM(CASE WHEN DAYS_BETWEEN(BIS2,ZCGDTFINA) BETWEEN 31 AND 60 THEN WERT2 ELSE 0 END) A2, 
SUM(CASE WHEN DAYS_BETWEEN(BIS2,ZCGDTFINA) BETWEEN 1 AND 30 THEN WERT2  ELSE 0 END) A1, 
SUM(CASE WHEN DAYS_BETWEEN(BIS2,ZCGDTFINA) BETWEEN 1 AND 90 THEN WERT2 ELSE 0 END) SOMA, 
SUM(CASE WHEN DAYS_BETWEEN(BIS2,ZCGDTFINA) BETWEEN 1 AND 90 THEN 1 ELSE 0 END) NUM, 
SUM(CASE WHEN (DAYS_BETWEEN(ZCGDTFINA,AB2) BETWEEN 1 AND 30) THEN WERT2 ELSE 0 END) P1,
SUM(CASE WHEN (DAYS_BETWEEN(ZCGDTFINA,AB2) BETWEEN 31 AND 60) THEN WERT2 ELSE 0 END) P2,
SUM(CASE WHEN (DAYS_BETWEEN(ZCGDTFINA,AB2) BETWEEN 61 AND 90) THEN WERT2 ELSE 0 END) P3,
SUM(CASE WHEN (DAYS_BETWEEN(ZCGDTFINA,AB2) BETWEEN 1 AND 90) THEN 1 ELSE 0 END) QTD_POS
FROM "CLB_CCS_ICC"."ZCT_DS_TAB004" NOTA
LEFT JOIN (SELECT ANLAGE ANLAGE2, AB AB2, BIS BIS2 , SUM(WERT1) WERT2 FROM
"NEO_COR"."neo.cor.data::MODEL.TABLES.ZCT_DS_CONSUMOS" CONS WHERE OPERAND in ('CA_FAT_TT', 'CA_FAT_RV', 'CA_FAT_NP', 'CA_FAT_FP', 'CA_FAT_EM', 'CA_FAT_LIM', 'CA_FAT_LNP') GROUP BY ANLAGE, AB, BIS  ) CONS
ON NOTA.ZCGINSTAL = CONS.ANLAGE2 WHERE ZCGTPNOTA = 'CI' AND ZCGDTFINA > '2017-01-01' AND ZCGUSRSTS IN ('VREL','CRRE','VNRE') 
AND URGRP IS NOT NULL

GROUP BY  NOTA.ZCGQMNUM , ZCGDTFINA , ANLAGE2 ))
)
) YY
ON A.NOTA = YY.NOTA


;

SELECT TOP 10 * --A.NOTA, A.CONTA_CONT, A.INST, A.DT_FIM_AVARIA, A.DT_ENCE, A.SETOR, A.UTD, A.DESC_EPS, A.TIPO, A.FAMILIA, A.COD_IRREG, A.CODSIT, A.CLASSE, A.ZCGTXTNOT, A.TARIFA, A.TENSAO, A.TIPO_MED, YY.MEDIA, YY.MES1_PER, YY.MES2_PER, YY.MES3_PER,

--CAST((CASE WHEN FAMILIA = '100' THEN ENER."Energia_irr" WHEN FAMILIA = '200' THEN ENER."Energia_def" END) AS DECIMAL (10,2)) AS PREV_ENERGIA ,A.ZCGUNLEIT

FROM
(SELECT 

TAB.ZCGQMNUM AS NOTA,
TAB.ZCGACCOUN AS CONTA_CONT,
TAB.ZCGINSTAL AS INST,
TAB.ZCGDTFINA AS DT_FIM_AVARIA,
TAB.ZCGDTENCE AS DT_ENCE,
ZZ.SETOR,
ZZ.UTD,
CT.DESC_EPS,
TAB.ZCGUSRSTS AS TIPO,
TAB.URGRP AS FAMILIA,
TAB.URCOD AS COD_IRREG,
CAB.CODSIT,
CI.CLASSE,
TAB.ZCGTXTNOT,
ZZ.ZCGTARTYP AS TARIFA,
ZZ.TARIFART AS TENSAO,
TIPO_MED,
ZZ.ZCGUNLEIT

FROM "CLB_CCS_ICC"."ZCT_DS_TAB004" TAB

LEFT JOIN "CLP124051"."PLANILHAO_NOTA_CI" CI
ON TAB.ZCGQMNUM = CI.NOTA

LEFT JOIN "CLP124051"."CENTRO_TRAB_NEW" CT
ON TAB.ZCGCTTRAB_COD = CT.COD_CENTRO_TRABALHO

LEFT JOIN "NEO_PEC"."neo.pec.data::MODEL.TABLES.ZCT_DS_CABECCD" CAB
ON TAB.ZCGQMNUM = CAB.QMNUM


LEFT JOIN (
SELECT *
FROM 
(SELECT ZCGINSTAL AS INSTA, MAX(ZCGDTLIGA) AS DTLIGA FROM "CLP124051"."PLANILHAO_CLIENTE"
--WHERE ZCGINSTAL = '0001675559'
GROUP BY ZCGINSTAL)
LEFT JOIN "CLP124051"."PLANILHAO_CLIENTE"
ON ZCGDTLIGA = DTLIGA AND ZCGINSTAL = INSTA
--WHERE ZCGINSTAL = '0001675559'
) ZZ
ON TAB.ZCGINSTAL = ZZ.ZCGINSTAL


WHERE ZCGTPNOTA = 'CI' AND ZCGUSRSTS IN ('CRRE','VREL') AND CI.CODSIT IN ('11','12','30','31','32','50') and VERSAO_ATUAL = 'X'

AND CI.ERDAT = '1900-01-01') A

--LEFT JOIN "CLP124051"."ENERGIA_NOTAS_FIM_AVARIA" ENER ON A.NOTA = ENER.NOTA




LEFT JOIN 
(SELECT * -- NOTA, INSTALACAO, MEDIA, MES1_PER, MES2_PER, MES3_PER
FROM
(
SELECT  NOTA, DATAC, INSTALACAO, A3, A2, A1 , MEDIA, P1,P2,P3,P4 ,QTD_POS, DT1, DT2, DT3, DT4,
P1-MEDIA AG1 , P2-MEDIA AG2 , P3-MEDIA AG, CAST( CASE WHEN P1>0 AND MEDIA>0 THEN (P1/MEDIA-1) ELSE 0 END AS DECIMAL (10,2)) AS MES1_PER,
CAST(CASE WHEN P2>0 AND MEDIA>0 THEN (P2/MEDIA-1) ELSE 0 END AS DECIMAL (10,2)) AS MES2_PER, CAST(CASE WHEN P3>0 AND MEDIA>0 THEN (P3/MEDIA-1) ELSE 0 END AS DECIMAL (10,2)) AS MES3_PER
FROM ( SELECT  NOTA, DATAC, INSTALACAO, A3, A2, A1 , 
CAST(CASE WHEN ( NUM = 0 OR NUM IS NULL) THEN 0 ELSE SOMA/NUM END AS DECIMAL(20,0)) MEDIA,
P1,P2,P3,P4, QTD_POS, DT1, DT2, DT3, DT4 FROM (
SELECT NOTA.ZCGQMNUM NOTA, ZCGDTFINA DATAC, ANLAGE2 INSTALACAO,
SUM(CASE WHEN DAYS_BETWEEN(BIS2,ZCGDTFINA) BETWEEN 61 AND 90 THEN WERT2 ELSE 0 END) A3, 
SUM(CASE WHEN DAYS_BETWEEN(BIS2,ZCGDTFINA) BETWEEN 31 AND 60 THEN WERT2 ELSE 0 END) A2, 
SUM(CASE WHEN DAYS_BETWEEN(BIS2,ZCGDTFINA) BETWEEN 1 AND 30 THEN WERT2  ELSE 0 END) A1, 
SUM(CASE WHEN DAYS_BETWEEN(BIS2,ZCGDTFINA) BETWEEN 1 AND 90 THEN WERT2 ELSE 0 END) SOMA, 
SUM(CASE WHEN DAYS_BETWEEN(BIS2,ZCGDTFINA) BETWEEN 1 AND 90 THEN 1 ELSE 0 END) NUM, 
SUM(CASE WHEN (DAYS_BETWEEN(ZCGDTFINA,AB2) BETWEEN 1 AND 30) THEN WERT2 ELSE 0 END) P1,
SUM(CASE WHEN (DAYS_BETWEEN(ZCGDTFINA,AB2) BETWEEN 31 AND 60) THEN WERT2 ELSE 0 END) P2,
SUM(CASE WHEN (DAYS_BETWEEN(ZCGDTFINA,AB2) BETWEEN 61 AND 90) THEN WERT2 ELSE 0 END) P3,
SUM(CASE WHEN (DAYS_BETWEEN(ZCGDTFINA,AB2) BETWEEN 91 AND 120) THEN WERT2 ELSE 0 END) P4,
SUM(CASE WHEN (DAYS_BETWEEN(ZCGDTFINA,AB2) BETWEEN 1 AND 120) THEN 1 ELSE 0 END) QTD_POS,
SUM(CASE WHEN (DAYS_BETWEEN(ZCGDTFINA,AB2) BETWEEN 1 AND 30) THEN DAYS_BETWEEN(ZCGDTFINA,AB2) ELSE 0 END) DT1,
SUM(CASE WHEN (DAYS_BETWEEN(ZCGDTFINA,AB2) BETWEEN 31 AND 60) THEN DAYS_BETWEEN(ZCGDTFINA,AB2) ELSE 0 END) DT2,
SUM(CASE WHEN (DAYS_BETWEEN(ZCGDTFINA,AB2) BETWEEN 61 AND 90) THEN DAYS_BETWEEN(ZCGDTFINA,AB2) ELSE 0 END) DT3,
SUM(CASE WHEN (DAYS_BETWEEN(ZCGDTFINA,AB2) BETWEEN 91 AND 120) THEN DAYS_BETWEEN(ZCGDTFINA,AB2) ELSE 0 END) DT4
FROM "CLB_CCS_ICC"."ZCT_DS_TAB004" NOTA
LEFT JOIN (SELECT ANLAGE ANLAGE2, AB AB2, BIS BIS2 , SUM(WERT1) WERT2 FROM
"NEO_COR"."neo.cor.data::MODEL.TABLES.ZCT_DS_CONSUMOS" CONS WHERE OPERAND in ('CA_FAT_TT', 'CA_FAT_RV', 'CA_FAT_NP', 'CA_FAT_FP', 'CA_FAT_EM', 'CA_FAT_LIM', 'CA_FAT_LNP') GROUP BY ANLAGE, AB, BIS  ) CONS
ON NOTA.ZCGINSTAL = CONS.ANLAGE2 WHERE ZCGTPNOTA = 'CI' AND ZCGDTFINA > '2017-01-01' AND ZCGUSRSTS IN ('VREL','CRRE','VNRE') 
AND URGRP IS NOT NULL

GROUP BY  NOTA.ZCGQMNUM , ZCGDTFINA , ANLAGE2 ))
)
) YY
ON A.NOTA = YY.NOTA
