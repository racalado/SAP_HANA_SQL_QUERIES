SELECT NOTA, DATAC, INSTALACAO, A3, A2, A1, SOMA, NUM,
		SUM(CASE WHEN POS.ORDEM = 1 THEN POS.WERT2 ELSE 0 END) P1,
		SUM(CASE WHEN POS.ORDEM = 2 THEN POS.WERT2 ELSE 0 END) P2,
		SUM(CASE WHEN POS.ORDEM = 3 THEN POS.WERT2 ELSE 0 END) P3,
		SUM(CASE WHEN POS.ORDEM = 4 THEN POS.WERT2 ELSE 0 END) P4,
		SUM(CASE WHEN POS.ORDEM IN (1,2,3) THEN 1 ELSE 0 END) QTD_POS,
		SUM(CASE WHEN POS.ORDEM = 1 THEN POS.DIAS ELSE 0 END) DT1,
		SUM(CASE WHEN POS.ORDEM = 2 THEN POS.DIAS ELSE 0 END) DT2,
		SUM(CASE WHEN POS.ORDEM = 3 THEN POS.DIAS ELSE 0 END) DT3,
		SUM(CASE WHEN POS.ORDEM = 4 THEN POS.DIAS ELSE 0 END) DT4

FROM (
	( SELECT DISTINCT NOTA.ZCGQMNUM NOTA, ZCGDTFINA DATAC, ZCGINSTAL INSTALACAO,
		SUM(CASE WHEN NOTA.ZCGQMNUM = ANT.NOTA AND ANT.ORDEM = 3 THEN ANT.WERT2 ELSE 0 END) A3, 
		SUM(CASE WHEN ANT.ORDEM = 2 THEN ANT.WERT2 ELSE 0 END) A2, 
		SUM(CASE WHEN ANT.ORDEM = 1 THEN ANT.WERT2 ELSE 0 END) A1, 
		SUM(CASE WHEN ANT.ORDEM IN (1,2,3) THEN ANT.WERT2 ELSE 0 END) SOMA, 
		SUM(CASE WHEN ANT.ORDEM IN (1,2,3) THEN 1 ELSE 0 END) NUM

	FROM "CLB_CCS_ICC"."ZCT_DS_TAB004" NOTA
		
		LEFT JOIN (
			SELECT * , ROW_NUMBER() OVER(PARTITION BY NOTA ORDER BY ABS(DIAS) ) AS ORDEM
			FROM (SELECT NOTA.ZCGQMNUM NOTA, ZCGDTFINA DATAC, ANLAGE2 INSTALACAO, WERT2, CONS.BIS2 DATA_LEIT, DAYS_BETWEEN(BIS2,ZCGDTFINA) DIAS
			FROM "CLB_CCS_ICC"."ZCT_DS_TAB004" NOTA
		
			LEFT JOIN (
			SELECT ANLAGE ANLAGE2, AB AB2, BIS BIS2, SUM(WERT1) WERT2
			FROM "NEO_COR"."neo.cor.data::MODEL.TABLES.ZCT_DS_CONSUMOS" CONS 
			WHERE OPERAND in ('CA_FAT_TT', 'CA_FAT_RV', 'CA_FAT_NP', 'CA_FAT_FP', 'CA_FAT_EM', 'CA_FAT_LIM', 'CA_FAT_LNP') AND BIS > '2018-01-01' 
			GROUP BY ANLAGE, AB, BIS  ) CONS
			ON NOTA.ZCGINSTAL = CONS.ANLAGE2 
			WHERE ZCGTPNOTA = 'CI' AND ZCGDTFINA > '2018-01-01' AND ZCGUSRSTS IN ('VREL','CRRE') AND URGRP IN ('100','200') AND BIS2 < ZCGDTFINA
			GROUP BY  NOTA.ZCGQMNUM , ZCGDTFINA , ANLAGE2, DAYS_BETWEEN(BIS2,ZCGDTFINA), CONS.BIS2, CONS.WERT2
			)ORDER BY  NOTA, DATA_LEIT DESC
				) ANT
		ON NOTA.ZCGQMNUM = ANT.NOTA AND NOTA.ZCGINSTAL = ANT.INSTALACAO
		
		WHERE ZCGTPNOTA = 'CI' AND NOTA.ZCGDTFINA > '2018-01-01' AND ZCGUSRSTS IN ('VREL','CRRE') AND URGRP IN ('100','200') 
		GROUP BY  NOTA.ZCGQMNUM , ZCGDTFINA , NOTA.ZCGINSTAL
		) ANTES
		
		LEFT JOIN (
		SELECT * , ROW_NUMBER() OVER(PARTITION BY NOTA ORDER BY ABS(DIAS) ) AS ORDEM 
		FROM ( SELECT NOTA.ZCGQMNUM NOTA, ZCGDTFINA DATAC, ANLAGE2 INSTALACAO, WERT2, CONS.BIS2 DATA_LEIT, DAYS_BETWEEN(ZCGDTFINA,BIS2) DIAS
		FROM "CLB_CCS_ICC"."ZCT_DS_TAB004" NOTA
		
		LEFT JOIN (
		SELECT ANLAGE ANLAGE2, AB AB2, BIS BIS2, SUM(WERT1) WERT2
		FROM "NEO_COR"."neo.cor.data::MODEL.TABLES.ZCT_DS_CONSUMOS" CONS 
		WHERE OPERAND in ('CA_FAT_TT', 'CA_FAT_RV', 'CA_FAT_NP', 'CA_FAT_FP', 'CA_FAT_EM', 'CA_FAT_LIM', 'CA_FAT_LNP') AND BIS > '2018-01-01' 
		GROUP BY ANLAGE, AB, BIS  ) CONS
		ON NOTA.ZCGINSTAL = CONS.ANLAGE2 
		WHERE ZCGTPNOTA = 'CI' AND ZCGDTFINA > '2018-01-01' AND ZCGUSRSTS IN ('VREL','CRRE') AND URGRP IN ('100','200') AND BIS2 > ZCGDTFINA
		GROUP BY  NOTA.ZCGQMNUM , ZCGDTFINA , ANLAGE2, DAYS_BETWEEN(BIS2,ZCGDTFINA), CONS.BIS2, CONS.WERT2
		)ORDER BY  NOTA, DATA_LEIT DESC
		) POS
		ON ANTES.NOTA = POS.NOTA
		)
		
GROUP BY NOTA, DATAC, INSTALACAO, A3, A2, A1, SOMA, NUM