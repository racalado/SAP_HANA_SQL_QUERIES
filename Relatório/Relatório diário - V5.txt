-- NO ANO NO ANO  NO ANO  NO ANO  NO ANO  NO ANO  NO ANO  NO ANO 

SELECT --SETOR,UTD , 
CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END EQUIPE,
tpnota_geracao GERACAO ,
SUM(INPS) AS INPS_TT,
SUM(TOI) AS TOI_TT, 
 SUM(F100) AS F100_TT, SUM(F200) AS F200_TT,  
 SUM(QTD_FAT) AS QTD_FAT_TT,
  SUM(QTD_CAN) AS QTD_CAN_TT,
   SUM(QTD_PEN) AS QTD_PEN_TT,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F100)/SUM(TOI) AS DECIMAL(10,4)) END AS F100_TOI_TT, 
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F200)/SUM(TOI) AS DECIMAL(10,4)) END AS F200_TOI_TT, 
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(TOI)/SUM(INPS) AS DECIMAL(10,4)) END AS PROC_TT, 
CASE WHEN (SUM(CASE WHEN (USERCODE IN('VNRE','VREL')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(((SUM(VNRE))/(SUM(CASE WHEN (USERCODE IN ('VNRE','VREL')) THEN 1 ELSE 0 END))) AS DECIMAL (10,4))) END AS IMPI_TT,
CAST((((SUM(CASE WHEN DADOS.STATUS IN ('AGUARDANDO_LAUDO','SEM_FATURAR') THEN 1 ELSE 0 END))*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END)*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END))/(SUM(TOI))) AS DECIMAL(10,2)) ) END))/1000) AS DECIMAL(10,2)) AS ENERGIA_PROJ,
CAST((SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/1000) AS DECIMAL(10,2)) AS MWH_TT, CAST((sum(agreg)/1000) AS DECIMAL(10,2)) as agreg_MWH_TT ,
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END AS KWHTOI_TT, 
CASE WHEN SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)=0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)AS DECIMAL(10,2))) END  AS KWHTOIFAT_TT,
CASE WHEN (SUM(INPS)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/(SUM(INPS))AS DECIMAL(10,2))) END AS KWHINSP_TT , 
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END))/(SUM(TOI))) AS DECIMAL(10,4)) ) END AS EFET_TT,
CASE WHEN (SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST((SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('FATURADO')) THEN 1 ELSE 0 END))/(SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') THEN 1 ELSE 0 END)) AS DECIMAL(10,4))) END  AS EFET_SEMP_TT,
CASE WHEN (SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.STATUS = 'FATURADO' THEN 1 ELSE 0 END)/SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END) AS DECIMAL(10,4)) ) END AS PERC_FAT_TT

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE LEFT(DATA_ENCE,4)= LEFT(CURRENT_DATE,4) AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') AND 
tpnota_geracao IS NOT NULL ) AS DADOS
left join (select nota , sum(ENERGIA) agreg from "CSR957313"."SIP_EN_AGREGADA" r group by nota ) a
on dados.nota = a.nota

GROUP BY CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END, tpnota_geracao
ORDER BY CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END, tpnota_geracao

;
--  FAT NO ANO  FAT NO ANO  FAT NO ANO  FAT NO ANO  FAT NO ANO  FAT NO ANO

SELECT 
CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END EQUIPE,
tpnota_geracao,
SUM(TOI) AS TOI_TT, 
 SUM(KWH_RECUPERADO) KWHR,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(KWH_RECUPERADO)/SUM(TOI) AS DECIMAL(10,4)) END AS KWHR_TOI 
-- TOTAIS - FINAIS

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE LEFT(ERDAT,4)= LEFT(CURRENT_DATE,4) AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') AND tpnota_geracao IS 
NOT NULL ) AS DADOS

GROUP BY CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END, tpnota_geracao
ORDER BY CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END, tpnota_geracao

;

---- NO MES  NO MES  NO MES  NO MES  NO MES  NO MES  NO MES  NO MES  NO MES  NO MES 

SELECT
CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END EQUIPE,
tpnota_geracao GERACAO ,
SUM(INPS) AS INPS_TT,
SUM(TOI) AS TOI_TT, 
 SUM(F100) AS F100_TT, SUM(F200) AS F200_TT,  
 SUM(QTD_FAT) AS QTD_FAT_TT,
  SUM(QTD_CAN) AS QTD_CAN_TT,
   SUM(QTD_PEN) AS QTD_PEN_TT,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F100)/SUM(TOI) AS DECIMAL(10,4)) END AS F100_TOI_TT, 
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F200)/SUM(TOI) AS DECIMAL(10,4)) END AS F200_TOI_TT, 
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(TOI)/SUM(INPS) AS DECIMAL(10,4)) END AS PROC_TT, 
CASE WHEN (SUM(CASE WHEN (USERCODE IN('VNRE','VREL')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(((SUM(VNRE))/(SUM(CASE WHEN (USERCODE IN ('VNRE','VREL')) THEN 1 ELSE 0 END))) AS DECIMAL (10,4))) END AS IMPI_TT,
CAST((((SUM(CASE WHEN DADOS.STATUS IN ('AGUARDANDO_LAUDO','SEM_FATURAR') THEN 1 ELSE 0 END))*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END)*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END))/(SUM(TOI))) AS DECIMAL(10,2)) ) END))/1000) AS DECIMAL(10,2)) AS ENERGIA_PROJ,
CAST((SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/1000) AS DECIMAL(10,2)) AS MWH_TT, CAST((sum(agreg)/1000) AS DECIMAL(10,2)) as agreg_MWH_TT ,
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END AS KWHTOI_TT, 
CASE WHEN SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)=0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)AS DECIMAL(10,2))) END  AS KWHTOIFAT_TT,
CASE WHEN (SUM(INPS)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/(SUM(INPS))AS DECIMAL(10,2))) END AS KWHINSP_TT , 
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END))/(SUM(TOI))) AS DECIMAL(10,4)) ) END AS EFET_TT,
CASE WHEN (SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST((SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('FATURADO')) THEN 1 ELSE 0 END))/(SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') THEN 1 ELSE 0 END)) AS DECIMAL(10,4))) END  AS EFET_SEMP_TT,
CASE WHEN (SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.STATUS = 'FATURADO' THEN 1 ELSE 0 END)/SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END) AS DECIMAL(10,4)) ) END AS PERC_FAT_TT


FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE LEFT(DATA_ENCE,7)= LEFT(CURRENT_DATE,7) AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') AND 
tpnota_geracao IS NOT NULL ) AS DADOS
left join (select nota , sum(ENERGIA) agreg from "CSR957313"."SIP_EN_AGREGADA" r group by nota ) a
on dados.nota = a.nota

GROUP BY CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END, tpnota_geracao
ORDER BY CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END, tpnota_geracao

;


 SELECT 
CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END EQUIPE,
tpnota_geracao,
SUM(TOI) AS TOI_TT, 
 SUM(KWH_RECUPERADO) KWHR,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(KWH_RECUPERADO)/SUM(TOI) AS DECIMAL(10,4)) END AS KWHR_TOI 

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE LEFT(ERDAT,7)= LEFT(CURRENT_DATE,7) AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') AND tpnota_geracao IS 
NOT NULL ) AS DADOS

GROUP BY CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END, tpnota_geracao
ORDER BY CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END, tpnota_geracao

;

-- NO DIA  NO DIA  NO DIA  NO DIA  NO DIA  NO DIA  NO DIA  NO DIA  NO DIA  NO DIA  NO DIA  NO DIA 

SELECT 
CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END EQUIPE,
tpnota_geracao GERACAO ,
SUM(INPS) AS INPS_TT,
SUM(TOI) AS TOI_TT, 
 SUM(F100) AS F100_TT, SUM(F200) AS F200_TT,  
 SUM(QTD_FAT) AS QTD_FAT_TT,
  SUM(QTD_CAN) AS QTD_CAN_TT,
   SUM(QTD_PEN) AS QTD_PEN_TT,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F100)/SUM(TOI) AS DECIMAL(10,4)) END AS F100_TOI_TT, 
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F200)/SUM(TOI) AS DECIMAL(10,4)) END AS F200_TOI_TT, 
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(TOI)/SUM(INPS) AS DECIMAL(10,4)) END AS PROC_TT, 
CASE WHEN (SUM(CASE WHEN (USERCODE IN('VNRE','VREL')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(((SUM(VNRE))/(SUM(CASE WHEN (USERCODE IN ('VNRE','VREL')) THEN 1 ELSE 0 END))) AS DECIMAL (10,4))) END AS IMPI_TT,
CAST((((SUM(CASE WHEN DADOS.STATUS IN ('AGUARDANDO_LAUDO','SEM_FATURAR') THEN 1 ELSE 0 END))*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END)*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END))/(SUM(TOI))) AS DECIMAL(10,2)) ) END))/1000) AS DECIMAL(10,2)) AS ENERGIA_PROJ,
CAST((SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/1000) AS DECIMAL(10,2)) AS MWH_TT, CAST((sum(agreg)/1000) AS DECIMAL(10,2)) as agreg_MWH_TT ,
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END AS KWHTOI_TT, 
CASE WHEN SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)=0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)AS DECIMAL(10,2))) END  AS KWHTOIFAT_TT,
CASE WHEN (SUM(INPS)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/(SUM(INPS))AS DECIMAL(10,2))) END AS KWHINSP_TT , 
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END))/(SUM(TOI))) AS DECIMAL(10,4)) ) END AS EFET_TT,
CASE WHEN (SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST((SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('FATURADO')) THEN 1 ELSE 0 END))/(SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') THEN 1 ELSE 0 END)) AS DECIMAL(10,4))) END  AS EFET_SEMP_TT,
CASE WHEN (SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.STATUS = 'FATURADO' THEN 1 ELSE 0 END)/SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END) AS DECIMAL(10,4)) ) END AS PERC_FAT_TT

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE 
DATA_ENCE = (CASE WHEN WEEKDAY(ADD_DAYS(CURRENT_DATE,-1))=6 THEN ADD_DAYS(CURRENT_DATE,-3) ELSE ADD_DAYS(CURRENT_DATE,-1) END)
AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') AND tpnota_geracao IS NOT NULL ) AS DADOS
left join (select nota , sum(ENERGIA) agreg from "CSR957313"."SIP_EN_AGREGADA" r group by nota ) a
on dados.nota = a.nota

GROUP BY CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END, tpnota_geracao
ORDER BY CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END, tpnota_geracao

;

-- NO DIA    FAT NO DIA    FAT NO DIA    FAT NO DIA    FAT NO DIA    FAT

 SELECT 
CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END EQUIPE,
tpnota_geracao,
SUM(TOI) AS TOI_TT, 
 SUM(KWH_RECUPERADO) KWHR,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(KWH_RECUPERADO)/SUM(TOI) AS DECIMAL(10,4)) END AS KWHR_TOI 

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE 
ERDAT = (CASE WHEN WEEKDAY(ADD_DAYS(CURRENT_DATE,-1))=6 THEN ADD_DAYS(CURRENT_DATE,-3) ELSE ADD_DAYS(CURRENT_DATE,-1) END)
AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') AND tpnota_geracao IS NOT NULL ) AS DADOS

GROUP BY CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END, tpnota_geracao
ORDER BY CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END, tpnota_geracao

;
--  MIX OCLE MÊS/MÊS   -  MIX OCLE MÊS/MÊS   -  MIX OCLE MÊS/MÊS   -  MIX OCLE MÊS/MÊS   - 

SELECT REF,
SUM(INPS) AS INPS_TT,
SUM(CASE WHEN DIRECIONADOR_RESUMIDO = 'OCLE' AND INPS = '1' THEN 1 ELSE 0 END) AS OCLE, 
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(CASE WHEN DIRECIONADOR_RESUMIDO = 'OCLE' AND INPS = '1' THEN 1 ELSE 0 END)/SUM(INPS) AS DECIMAL(10,4)) END AS P_OCLE,
SUM(CASE WHEN DIRECIONADOR_RESUMIDO = 'PROTECAO A RECEITA' AND INPS = '1' THEN 1 ELSE 0 END) AS PROT,
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(CASE WHEN DIRECIONADOR_RESUMIDO = 'PROTECAO A RECEITA' AND INPS = '1' THEN 1 ELSE 0 END)/SUM(INPS) AS DECIMAL(10,4)) END AS P_PROT,
SUM(CASE WHEN DIRECIONADOR_RESUMIDO = 'ANALISE DE CONSUMO' AND INPS = '1' THEN 1 ELSE 0 END) AS ANCO,
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(CASE WHEN DIRECIONADOR_RESUMIDO = 'ANALISE DE CONSUMO' AND INPS = '1' THEN 1 ELSE 0 END)/SUM(INPS) AS DECIMAL(10,4)) END AS P_ANCO,
SUM(CASE WHEN DIRECIONADOR_RESUMIDO NOT IN ( 'OCLE','PROTECAO A RECEITA','ANALISE DE CONSUMO' ) AND INPS = '1' THEN 1 ELSE 0 END) AS OUTROS, 
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(CASE WHEN DIRECIONADOR_RESUMIDO NOT IN ( 'OCLE','PROTECAO A RECEITA','ANALISE DE CONSUMO' ) AND INPS = '1' THEN 1 ELSE 0 END)/SUM(INPS) AS DECIMAL(10,4)) END AS P_OUTROS,
SUM(TOI) AS TOI_TT
-- TOTAIS - FINAIS

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') AND GERACAO = 'NS' AND DATA_ENCE >= '2018-01-01') AS DADOS
left join (select nota , sum(ENERGIA) agreg from "CSR957313"."SIP_EN_AGREGADA" r group by nota ) a
on dados.nota = a.nota
GROUP BY REF


;


--  MES A MES - EQUIPE    MES A MES - EQUIPE    MES A MES - EQUIPE    MES A MES - EQUIPE  

SELECT LEFT(DATA_ENCE,7) REF,
SUM(INPS) AS INPS_TT,
SUM(TOI) AS TOI_TT, 
 SUM(F100) AS F100_TT, SUM(F200) AS F200_TT,  
 SUM(QTD_FAT) AS QTD_FAT_TT,
  SUM(QTD_CAN) AS QTD_CAN_TT,
   SUM(QTD_PEN) AS QTD_PEN_TT,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F100)/SUM(TOI) AS DECIMAL(10,4)) END AS F100_TOI_TT, 
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F200)/SUM(TOI) AS DECIMAL(10,4)) END AS F200_TOI_TT, 
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(TOI)/SUM(INPS) AS DECIMAL(10,4)) END AS PROC_TT, 
CASE WHEN (SUM(CASE WHEN (USERCODE IN('VNRE','VREL')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(((SUM(VNRE))/(SUM(CASE WHEN (USERCODE IN ('VNRE','VREL')) THEN 1 ELSE 0 END))) AS DECIMAL (10,4))) END AS IMPI_TT,
CAST((((SUM(CASE WHEN DADOS.STATUS IN ('AGUARDANDO_LAUDO','SEM_FATURAR') THEN 1 ELSE 0 END))*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END)*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END))/(SUM(TOI))) AS DECIMAL(10,2)) ) END))/1000) AS DECIMAL(10,2)) AS ENERGIA_PROJ,
CAST((SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/1000) AS DECIMAL(10,2)) AS MWH_TT, CAST((sum(agreg)/1000) AS DECIMAL(10,2)) as agreg_MWH_TT ,
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END AS KWHTOI_TT, 
CASE WHEN SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)=0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)AS DECIMAL(10,2))) END  AS KWHTOIFAT_TT,
CASE WHEN (SUM(INPS)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/(SUM(INPS))AS DECIMAL(10,2))) END AS KWHINSP_TT , 
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END))/(SUM(TOI))) AS DECIMAL(10,4)) ) END AS EFET_TT,
CASE WHEN (SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST((SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('FATURADO')) THEN 1 ELSE 0 END))/(SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') THEN 1 ELSE 0 END)) AS DECIMAL(10,4))) END  AS EFET_SEMP_TT,
CASE WHEN (SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.STATUS = 'FATURADO' THEN 1 ELSE 0 END)/SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END) AS DECIMAL(10,4)) ) END AS PERC_FAT_TT

-- TOTAIS - FINAIS

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE LEFT(DATA_ENCE,4)> '2018' AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') AND GERACAO = 

'NS') AS DADOS
left join (select nota , sum(ENERGIA) agreg from "CSR957313"."SIP_EN_AGREGADA" r group by nota ) a
on dados.nota = a.nota
GROUP BY LEFT(DATA_ENCE,7)
ORDER BY LEFT(DATA_ENCE,7)

;
-- FAT MES A MES    FAT MES A MES    FAT MES A MES    FAT MES A MES    FAT MES A MES   

SELECT --SETOR,UTD , 
LEFT(ERDAT,7) FAT,
SUM(TOI) AS TOI_TT, 
 SUM(KWH_RECUPERADO) KWHR,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(KWH_RECUPERADO)/SUM(TOI) AS DECIMAL(10,4)) END AS KWHR_TOI,
COUNT( DISTINCT ERDAT) DD,
SUM(TOI)/COUNT( DISTINCT ERDAT) FAT_DIA,
CASE WHEN COUNT( DISTINCT ERDAT) = 0 THEN 0 ELSE CAST(SUM(KWH_RECUPERADO)/COUNT( DISTINCT ERDAT) AS DECIMAL(10,4)) END AS KWHR_DIA
-- TOTAIS - FINAIS

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE LEFT(ERDAT,4) > '2018'  AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') ) AS DADOS

GROUP BY LEFT(ERDAT,7)
ORDER BY LEFT(ERDAT,7)


;
-- FAT DIA A DIA    FAT DIA A DIA    FAT DIA A DIA    FAT DIA A DIA    FAT DIA A DIA    FAT DIA A DIA    FAT DIA A DIA   

SELECT 
ERDAT FAT,
SUM(TOI) AS TOI_TT, 
 SUM(KWH_RECUPERADO) KWHR,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(KWH_RECUPERADO)/SUM(TOI) AS DECIMAL(10,4)) END AS KWHR_TOI
-- TOTAIS - FINAIS

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE ERDAT >= '2020-01-01'  AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') ) AS DADOS

GROUP BY ERDAT
ORDER BY ERDAT

;

SELECT LEFT(DATA_ENCE,7) REF,
SUM(INPS) AS INPS_TT,
SUM(CASE WHEN FAMILIA = '100' AND INPS = '1' THEN 1 ELSE 0 END) AS F100, 
SUM(CASE WHEN FAMILIA = '100' AND INPS = '1' AND CAUSA IN ('103','106','107','201','202','210') THEN 1 ELSE 0 END) AS F100_AFE, 
SUM(CASE WHEN FAMILIA = '200' AND INPS = '1' THEN 1 ELSE 0 END) AS F200, 
SUM(CASE WHEN FAMILIA = '200' AND INPS = '1' AND CAUSA IN ('103','106','107','201','202','210') THEN 1 ELSE 0 END) AS F200_AFE, 
SUM(CASE WHEN CAUSA IN ('103','106','107','201','202','210') AND INPS = '1' THEN 1 ELSE 0 END) AS AFERICAO, 
SUM(TOI) AS TOI_TT,
COUNT(DISTINCT DATA_ENCE) DIA,
SUM(TOI)/COUNT(DISTINCT DATA_ENCE) TOI_DIA

-- TOTAIS - FINAIS

FROM (SELECT * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE  DATA_ENCE >= '2019-01-01' ) AS DADOS
left join (select nota , sum(ENERGIA) agreg from "CSR957313"."SIP_EN_AGREGADA" r group by nota ) a
on dados.nota = a.nota
GROUP BY LEFT(DATA_ENCE,7)
ORDER BY LEFT(DATA_ENCE,7)

;
-- INSP TOTAL MES A MES     INSP TOTAL MES A MES     INSP TOTAL MES A MES     INSP TOTAL MES A MES    

SELECT LEFT(DATA_ENCE,7) REF,
SUM(INPS) AS INPS_TT,
SUM(TOI) AS TOI_TT, 
 SUM(F100) AS F100_TT, SUM(F200) AS F200_TT,  
 SUM(QTD_FAT) AS QTD_FAT_TT,
  SUM(QTD_CAN) AS QTD_CAN_TT,
   SUM(QTD_PEN) AS QTD_PEN_TT,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F100)/SUM(TOI) AS DECIMAL(10,4)) END AS F100_TOI_TT, 
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F200)/SUM(TOI) AS DECIMAL(10,4)) END AS F200_TOI_TT, 
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(TOI)/SUM(INPS) AS DECIMAL(10,4)) END AS PROC_TT, 
CASE WHEN (SUM(CASE WHEN (USERCODE IN('VNRE','VREL')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(((SUM(VNRE))/(SUM(CASE WHEN (USERCODE IN ('VNRE','VREL')) THEN 1 ELSE 0 END))) AS DECIMAL (10,4))) END AS IMPI_TT,
CAST((((SUM(CASE WHEN DADOS.STATUS IN ('AGUARDANDO_LAUDO','SEM_FATURAR') THEN 1 ELSE 0 END))*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END)*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END))/(SUM(TOI))) AS DECIMAL(10,2)) ) END))/1000) AS DECIMAL(10,2)) AS ENERGIA_PROJ,
CAST((SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/1000) AS DECIMAL(10,2)) AS MWH_TT, CAST((sum(agreg)/1000) AS DECIMAL(10,2)) as agreg_MWH_TT ,
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END AS KWHTOI_TT, 
CASE WHEN SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)=0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)AS DECIMAL(10,2))) END  AS KWHTOIFAT_TT,
CASE WHEN (SUM(INPS)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/(SUM(INPS))AS DECIMAL(10,2))) END AS KWHINSP_TT , 
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END))/(SUM(TOI))) AS DECIMAL(10,4)) ) END AS EFET_TT,
CASE WHEN (SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST((SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('FATURADO')) THEN 1 ELSE 0 END))/(SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') THEN 1 ELSE 0 END)) AS DECIMAL(10,4))) END  AS EFET_SEMP_TT,
CASE WHEN (SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.STATUS = 'FATURADO' THEN 1 ELSE 0 END)/SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END) AS DECIMAL(10,4)) ) END AS PERC_FAT_TT

-- TOTAIS - FINAIS

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE LEFT(DATA_ENCE,4)> '2018' AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') ) AS DADOS
left join (select nota , sum(ENERGIA) agreg from "CSR957313"."SIP_EN_AGREGADA" r group by nota ) a
on dados.nota = a.nota
GROUP BY LEFT(DATA_ENCE,7)
ORDER BY LEFT(DATA_ENCE,7)

;

-- ENTRADA E SAIDA DIA A DIA 

SELECT 
A.*, B.CANC, C.FATURA, TOI_TT-B.CANC-C.FATURA DESVIO FROM
(SELECT DATA_ENCE,
SUM(INPS) AS INPS_TT,
SUM(CASE WHEN FAMILIA = '100' AND INPS = '1' THEN 1 ELSE 0 END) AS F100, 
SUM(CASE WHEN FAMILIA = '100' AND INPS = '1' AND CAUSA IN ('103','106','107','201','202','210') THEN 1 ELSE 0 END) AS F100_AFE, 
SUM(CASE WHEN FAMILIA = '200' AND INPS = '1' THEN 1 ELSE 0 END) AS F200, 
SUM(CASE WHEN FAMILIA = '200' AND INPS = '1' AND CAUSA IN ('103','106','107','201','202','210') THEN 1 ELSE 0 END) AS F200_AFE, 
SUM(CASE WHEN CAUSA IN ('103','106','107','201','202','210') AND INPS = '1' THEN 1 ELSE 0 END) AS AFERICAO, 
SUM(TOI) AS TOI_TT,
WEEKDAY(DATA_ENCE) DIA

-- TOTAIS - FINAIS

FROM (SELECT * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE  DATA_ENCE >= '2020-01-01' AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') ) AS DADOS
left join (select nota , sum(ENERGIA) agreg from "CSR957313"."SIP_EN_AGREGADA" r group by nota ) a
on dados.nota = a.nota
GROUP BY DATA_ENCE
ORDER BY DATA_ENCE) A
LEFT JOIN 
(SELECT DT_CONCLUS,
SUM(INPS) AS CANC FROM
"CLP124051"."PLANILHAO_NOTA_CI"
WHERE CODSIT = 90
GROUP BY DT_CONCLUS) B
ON DATA_ENCE = DT_CONCLUS

LEFT JOIN 
(SELECT 
ERDAT FAT,
SUM(TOI) AS FATURA, 
 SUM(KWH_RECUPERADO) KWHR,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(KWH_RECUPERADO)/SUM(TOI) AS DECIMAL(10,4)) END AS KWHR_TOI
-- TOTAIS - FINAIS

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE ERDAT >= '2020-01-01'  AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') ) AS DADOS

GROUP BY ERDAT
ORDER BY ERDAT) C
ON A.DATA_ENCE = C.FAT

;

-- IPP DIA     IPP DIA     IPP DIA     IPP DIA     IPP DIA    

SELECT COUNT(*) FROM (SELECT *

FROM
(SELECT *

FROM "CLB_CCS_ICC"."ZCT_DS_TAB004" TAB

LEFT JOIN "CLP124051"."PLANILHAO_NOTA_CI" CI
ON TAB.ZCGQMNUM = CI.NOTA

LEFT JOIN "NEO_PEC"."neo.pec.data::MODEL.TABLES.ZCT_DS_CABECCD" CAB
ON TAB.ZCGQMNUM = CAB.QMNUM

LEFT JOIN (SELECT * FROM "CLP124051"."PLANILHAO_CLIENTE" WHERE SEQCC = 1) ZZ
ON TAB.ZCGINSTAL = ZZ.ZCGINSTAL

WHERE ZCGTPNOTA = 'CI' AND ZCGUSRSTS IN ('CRRE','VREL') AND CI.CODSIT IN ('11','12','30','31','32','50') and VERSAO_ATUAL = 'X'
AND CI.ERDAT = '1900-01-01') A

)

