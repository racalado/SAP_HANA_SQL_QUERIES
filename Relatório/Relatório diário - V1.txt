-- NO ANO NO ANO  NO ANO  NO ANO  NO ANO  NO ANO  NO ANO  NO ANO 


SELECT --SETOR,UTD , 
CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END EQUIPE,
tpnota_geracao GERACAO ,

SUM(INPS) AS INPS_TT,
SUM(TOI) AS TOI_TT, 
 SUM(F100) AS F100_TT, SUM(F200) AS F200_TT,  
 SUM(QTD_FAT) AS QTD_FAT_TT,
  SUM(QTD_CAN) AS QTD_CAN_TT,
   SUM(QTD_PEN) AS QTD_PEN_TT,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F100)/SUM(TOI) AS DECIMAL(10,4)) END AS F100_TOI_TT, 
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F200)/SUM(TOI) AS DECIMAL(10,4)) END AS F200_TOI_TT, 
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(TOI)/SUM(INPS) AS DECIMAL(10,4)) END AS PROC_TT, 
CASE WHEN (SUM(CASE WHEN (USERCODE IN('VNRE','VREL')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(((SUM(VNRE))/(SUM(CASE WHEN (USERCODE IN
('VNRE','VREL')) THEN 1 ELSE 0 END))) AS DECIMAL (10,4))) END AS IMPI_TT,
CAST((((SUM(CASE WHEN DADOS.STATUS IN ('AGUARDANDO_LAUDO','SEM_FATURAR') THEN 1 ELSE 0 END))*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE 
WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END)*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM
(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END))/(SUM(TOI))) AS DECIMAL(10,2)) ) END))/1000) 
AS DECIMAL(10,2)) AS ENERGIA_PROJ,
CAST((SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/1000) AS DECIMAL(10,2)) AS MWH_TT, 
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END  
AS KWHTOI_TT, 
CASE WHEN SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)=0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO 
ELSE 0 END)/SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)AS DECIMAL(10,2))) END  AS KWHTOIFAT_TT,
CASE WHEN (SUM(INPS)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/(SUM(INPS))AS DECIMAL(10,2))) 
END AS KWHINSP_TT , 
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 
END))/(SUM(TOI))) AS DECIMAL(10,4)) ) END AS EFET_TT,
CASE WHEN (SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST((SUM(CASE WHEN 
(DADOS.CAUSA < 299 AND DADOS.STATUS IN ('FATURADO')) THEN 1 ELSE 0 END))/(SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') 
THEN 1 ELSE 0 END)) AS DECIMAL(10,4))) END  AS EFET_SEMP_TT,
CASE WHEN (SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(SUM
(CASE WHEN DADOS.STATUS = 'FATURADO' THEN 1 ELSE 0 END)/SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) 
THEN 1 ELSE 0 END) AS DECIMAL(10,4)) ) END AS PERC_FAT_TT

-- TOTAIS - FINAIS

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE LEFT(DATA_ENCE,4)= LEFT(CURRENT_DATE,4) AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') AND 
tpnota_geracao IS NOT NULL ) AS DADOS

GROUP BY --SETOR,UTD ,
CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END, tpnota_geracao
--ORDER BY --SETOR , UTD
ORDER BY --SETOR,UTD ,
CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END, tpnota_geracao
--ORDER BY --SETOR , UTD
;


 SELECT --SETOR,UTD , 
CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END EQUIPE,
tpnota_geracao,
SUM(TOI) AS TOI_TT, 
 SUM(KWH_RECUPERADO) KWHR,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(KWH_RECUPERADO)/SUM(TOI) AS DECIMAL(10,4)) END AS KWHR_TOI 
-- TOTAIS - FINAIS

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE LEFT(ERDAT,4)= LEFT(CURRENT_DATE,4) AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') AND tpnota_geracao IS 
NOT NULL ) AS DADOS

GROUP BY --SETOR,UTD , 
CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END, tpnota_geracao
--ORDER BY SETOR , UTD
ORDER BY --SETOR,UTD ,
CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END, tpnota_geracao
--ORDER BY --SETOR , UTD
;






---- NO MES  NO MES  NO MES  NO MES  NO MES  NO MES  NO MES  NO MES  NO MES  NO MES 


SELECT --SETOR,UTD , 
CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END EQUIPE,
tpnota_geracao GERACAO ,

SUM(INPS) AS INPS_TT,
SUM(TOI) AS TOI_TT, 
 SUM(F100) AS F100_TT, SUM(F200) AS F200_TT,  
 SUM(QTD_FAT) AS QTD_FAT_TT,
  SUM(QTD_CAN) AS QTD_CAN_TT,
   SUM(QTD_PEN) AS QTD_PEN_TT,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F100)/SUM(TOI) AS DECIMAL(10,4)) END AS F100_TOI_TT, 
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F200)/SUM(TOI) AS DECIMAL(10,4)) END AS F200_TOI_TT, 
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(TOI)/SUM(INPS) AS DECIMAL(10,4)) END AS PROC_TT, 
CASE WHEN (SUM(CASE WHEN (USERCODE IN('VNRE','VREL')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(((SUM(VNRE))/(SUM(CASE WHEN (USERCODE IN

('VNRE','VREL')) THEN 1 ELSE 0 END))) AS DECIMAL (10,4))) END AS IMPI_TT,
CAST((((SUM(CASE WHEN DADOS.STATUS IN ('AGUARDANDO_LAUDO','SEM_FATURAR') THEN 1 ELSE 0 END))*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE 

WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END)*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM

(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END))/(SUM(TOI))) AS DECIMAL(10,2)) ) END))/1000) 

AS DECIMAL(10,2)) AS ENERGIA_PROJ,
CAST((SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/1000) AS DECIMAL(10,2)) AS MWH_TT, 

CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END  

AS KWHTOI_TT, 
CASE WHEN SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)=0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO 

ELSE 0 END)/SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)AS DECIMAL(10,2))) END  AS KWHTOIFAT_TT,

CASE WHEN (SUM(INPS)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/(SUM(INPS))AS DECIMAL(10,2))) 

END AS KWHINSP_TT , 
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 

END))/(SUM(TOI))) AS DECIMAL(10,4)) ) END AS EFET_TT,
CASE WHEN (SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST((SUM(CASE WHEN 

(DADOS.CAUSA < 299 AND DADOS.STATUS IN ('FATURADO')) THEN 1 ELSE 0 END))/(SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') 

THEN 1 ELSE 0 END)) AS DECIMAL(10,4))) END  AS EFET_SEMP_TT,
CASE WHEN (SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(SUM

(CASE WHEN DADOS.STATUS = 'FATURADO' THEN 1 ELSE 0 END)/SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) 

THEN 1 ELSE 0 END) AS DECIMAL(10,4)) ) END AS PERC_FAT_TT

-- TOTAIS - FINAIS

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE LEFT(DATA_ENCE,7)= LEFT(CURRENT_DATE,7) AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') AND 

tpnota_geracao IS NOT NULL ) AS DADOS

GROUP BY --SETOR,UTD ,
CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END, tpnota_geracao
--ORDER BY --SETOR , UTD
ORDER BY --SETOR,UTD ,
CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END, tpnota_geracao
--ORDER BY --SETOR , UTD
;


 SELECT --SETOR,UTD , 
CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END EQUIPE,
tpnota_geracao,
SUM(TOI) AS TOI_TT, 
 SUM(KWH_RECUPERADO) KWHR,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(KWH_RECUPERADO)/SUM(TOI) AS DECIMAL(10,4)) END AS KWHR_TOI 
-- TOTAIS - FINAIS

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE LEFT(ERDAT,7)= LEFT(CURRENT_DATE,7) AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') AND tpnota_geracao IS 

NOT NULL ) AS DADOS

GROUP BY --SETOR,UTD , 
CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END, tpnota_geracao
--ORDER BY SETOR , UTD
ORDER BY --SETOR,UTD ,
CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END, tpnota_geracao
--ORDER BY --SETOR , UTD

;


-- NO DIA  NO DIA  NO DIA  NO DIA  NO DIA  NO DIA  NO DIA  NO DIA  NO DIA  NO DIA  NO DIA  NO DIA 


SELECT --SETOR,UTD , 
CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END EQUIPE,
tpnota_geracao GERACAO ,

SUM(INPS) AS INPS_TT,
SUM(TOI) AS TOI_TT, 
 SUM(F100) AS F100_TT, SUM(F200) AS F200_TT,  
 SUM(QTD_FAT) AS QTD_FAT_TT,
  SUM(QTD_CAN) AS QTD_CAN_TT,
   SUM(QTD_PEN) AS QTD_PEN_TT,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F100)/SUM(TOI) AS DECIMAL(10,4)) END AS F100_TOI_TT, 
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F200)/SUM(TOI) AS DECIMAL(10,4)) END AS F200_TOI_TT, 
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(TOI)/SUM(INPS) AS DECIMAL(10,4)) END AS PROC_TT, 
CASE WHEN (SUM(CASE WHEN (USERCODE IN('VNRE','VREL')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(((SUM(VNRE))/(SUM(CASE WHEN (USERCODE IN

('VNRE','VREL')) THEN 1 ELSE 0 END))) AS DECIMAL (10,4))) END AS IMPI_TT,
CAST((((SUM(CASE WHEN DADOS.STATUS IN ('AGUARDANDO_LAUDO','SEM_FATURAR') THEN 1 ELSE 0 END))*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE 

WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END)*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM

(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END))/(SUM(TOI))) AS DECIMAL(10,2)) ) END))/1000) 

AS DECIMAL(10,2)) AS ENERGIA_PROJ,
CAST((SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/1000) AS DECIMAL(10,2)) AS MWH_TT, 

CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END  

AS KWHTOI_TT, 
CASE WHEN SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)=0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO 

ELSE 0 END)/SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)AS DECIMAL(10,2))) END  AS KWHTOIFAT_TT,

CASE WHEN (SUM(INPS)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/(SUM(INPS))AS DECIMAL(10,2))) 

END AS KWHINSP_TT , 
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 

END))/(SUM(TOI))) AS DECIMAL(10,4)) ) END AS EFET_TT,
CASE WHEN (SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST((SUM(CASE WHEN 

(DADOS.CAUSA < 299 AND DADOS.STATUS IN ('FATURADO')) THEN 1 ELSE 0 END))/(SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') 

THEN 1 ELSE 0 END)) AS DECIMAL(10,4))) END  AS EFET_SEMP_TT,
CASE WHEN (SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(SUM

(CASE WHEN DADOS.STATUS = 'FATURADO' THEN 1 ELSE 0 END)/SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) 

THEN 1 ELSE 0 END) AS DECIMAL(10,4)) ) END AS PERC_FAT_TT

-- TOTAIS - FINAIS

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE 
DATA_ENCE = (CASE WHEN WEEKDAY(ADD_DAYS(CURRENT_DATE,-1))=6 THEN ADD_DAYS(CURRENT_DATE,-3) ELSE ADD_DAYS(CURRENT_DATE,-1) END)
AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') AND tpnota_geracao IS NOT NULL ) AS DADOS

GROUP BY --SETOR,UTD ,
CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END, tpnota_geracao
--ORDER BY --SETOR , UTD
ORDER BY --SETOR,UTD ,
CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END, tpnota_geracao
--ORDER BY --SETOR , UTD
;


 SELECT --SETOR,UTD , 
CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END EQUIPE,
tpnota_geracao,
SUM(TOI) AS TOI_TT, 
 SUM(KWH_RECUPERADO) KWHR,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(KWH_RECUPERADO)/SUM(TOI) AS DECIMAL(10,4)) END AS KWHR_TOI 
-- TOTAIS - FINAIS

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE 
ERDAT = (CASE WHEN WEEKDAY(ADD_DAYS(CURRENT_DATE,-1))=6 THEN ADD_DAYS(CURRENT_DATE,-3) ELSE ADD_DAYS(CURRENT_DATE,-1) END)
AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') AND tpnota_geracao IS NOT NULL ) AS DADOS

GROUP BY --SETOR,UTD , 
CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END, tpnota_geracao
--ORDER BY SETOR , UTD;
ORDER BY --SETOR,UTD ,
CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END, tpnota_geracao
--ORDER BY --SETOR , UTD

;
--  MES A MES - SETOR   MES A MES - SETOR   MES A MES - SETOR   MES A MES - SETOR   MES A MES - SETOR  

SELECT LEFT(DATA_ENCE,7) REF, SETOR,
SUM(INPS) AS INPS_TT,
SUM(TOI) AS TOI_TT, 
 SUM(F100) AS F100_TT, SUM(F200) AS F200_TT,  
 SUM(QTD_FAT) AS QTD_FAT_TT,
  SUM(QTD_CAN) AS QTD_CAN_TT,
   SUM(QTD_PEN) AS QTD_PEN_TT,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F100)/SUM(TOI) AS DECIMAL(10,4)) END AS F100_TOI_TT, 
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F200)/SUM(TOI) AS DECIMAL(10,4)) END AS F200_TOI_TT, 
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(TOI)/SUM(INPS) AS DECIMAL(10,4)) END AS PROC_TT, 
CASE WHEN (SUM(CASE WHEN (USERCODE IN('VNRE','VREL')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(((SUM(VNRE))/(SUM(CASE WHEN (USERCODE IN

('VNRE','VREL')) THEN 1 ELSE 0 END))) AS DECIMAL (10,4))) END AS IMPI_TT,
CAST((((SUM(CASE WHEN DADOS.STATUS IN ('AGUARDANDO_LAUDO','SEM_FATURAR') THEN 1 ELSE 0 END))*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE 

WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END)*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM

(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END))/(SUM(TOI))) AS DECIMAL(10,2)) ) END))/1000) 

AS DECIMAL(10,2)) AS ENERGIA_PROJ,
CAST((SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/1000) AS DECIMAL(10,2)) AS MWH_TT, 
CAST((sum(agreg)/1000) AS DECIMAL(10,2)) as agreg_MWH_TT ,
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END  

AS KWHTOI_TT, 
CASE WHEN SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)=0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO 

ELSE 0 END)/SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)AS DECIMAL(10,2))) END  AS KWHTOIFAT_TT,

CASE WHEN (SUM(INPS)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/(SUM(INPS))AS DECIMAL(10,2))) 

END AS KWHINSP_TT , 
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 

END))/(SUM(TOI))) AS DECIMAL(10,4)) ) END AS EFET_TT,
CASE WHEN (SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST((SUM(CASE WHEN 

(DADOS.CAUSA < 299 AND DADOS.STATUS IN ('FATURADO')) THEN 1 ELSE 0 END))/(SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') 

THEN 1 ELSE 0 END)) AS DECIMAL(10,4))) END  AS EFET_SEMP_TT,
CASE WHEN (SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(SUM

(CASE WHEN DADOS.STATUS = 'FATURADO' THEN 1 ELSE 0 END)/SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) 

THEN 1 ELSE 0 END) AS DECIMAL(10,4)) ) END AS PERC_FAT_TT

-- TOTAIS - FINAIS

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE LEFT(DATA_ENCE,4)= LEFT(CURRENT_DATE,4) AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') AND GERACAO = 

'NS') AS DADOS
left join (select nota , sum(consumo) agreg from "CSR957313"."SIP_EN_AGREGADA" r group by nota ) a
on dados.nota = a.nota
GROUP BY LEFT(DATA_ENCE,7) , SETOR
ORDER BY SETOR, LEFT(DATA_ENCE,7)
;
-- MES ATUAL - SETOR   MES ATUAL - SETOR   MES ATUAL - SETOR   MES ATUAL - SETOR   MES ATUAL - SETOR  

SELECT LEFT(DATA_ENCE,7) REF, SETOR,
SUM(INPS) AS INPS_TT,
SUM(TOI) AS TOI_TT, 
 SUM(F100) AS F100_TT, SUM(F200) AS F200_TT,  
 SUM(QTD_FAT) AS QTD_FAT_TT,
  SUM(QTD_CAN) AS QTD_CAN_TT,
   SUM(QTD_PEN) AS QTD_PEN_TT,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F100)/SUM(TOI) AS DECIMAL(10,4)) END AS F100_TOI_TT, 
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F200)/SUM(TOI) AS DECIMAL(10,4)) END AS F200_TOI_TT, 
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(TOI)/SUM(INPS) AS DECIMAL(10,4)) END AS PROC_TT, 
CASE WHEN (SUM(CASE WHEN (USERCODE IN('VNRE','VREL')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(((SUM(VNRE))/(SUM(CASE WHEN (USERCODE IN

('VNRE','VREL')) THEN 1 ELSE 0 END))) AS DECIMAL (10,4))) END AS IMPI_TT,
CAST((((SUM(CASE WHEN DADOS.STATUS IN ('AGUARDANDO_LAUDO','SEM_FATURAR') THEN 1 ELSE 0 END))*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE 

WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END)*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM

(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END))/(SUM(TOI))) AS DECIMAL(10,2)) ) END))/1000) 

AS DECIMAL(10,2)) AS ENERGIA_PROJ,
CAST((SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/1000) AS DECIMAL(10,2)) AS MWH_TT, 
CAST((sum(agreg)/1000) AS DECIMAL(10,2)) as agreg_MWH_TT ,
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END  

AS KWHTOI_TT, 
CASE WHEN SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)=0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO 

ELSE 0 END)/SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)AS DECIMAL(10,2))) END  AS KWHTOIFAT_TT,

CASE WHEN (SUM(INPS)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/(SUM(INPS))AS DECIMAL(10,2))) 

END AS KWHINSP_TT , 
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 

END))/(SUM(TOI))) AS DECIMAL(10,4)) ) END AS EFET_TT,
CASE WHEN (SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST((SUM(CASE WHEN 

(DADOS.CAUSA < 299 AND DADOS.STATUS IN ('FATURADO')) THEN 1 ELSE 0 END))/(SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') 

THEN 1 ELSE 0 END)) AS DECIMAL(10,4))) END  AS EFET_SEMP_TT,
CASE WHEN (SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(SUM

(CASE WHEN DADOS.STATUS = 'FATURADO' THEN 1 ELSE 0 END)/SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) 

THEN 1 ELSE 0 END) AS DECIMAL(10,4)) ) END AS PERC_FAT_TT

-- TOTAIS - FINAIS

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE LEFT(DATA_ENCE,7)= LEFT(CURRENT_DATE,7) AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') AND GERACAO = 

'NS') AS DADOS
left join (select nota , sum(consumo) agreg from "CSR957313"."SIP_EN_AGREGADA" r group by nota ) a
on dados.nota = a.nota
GROUP BY LEFT(DATA_ENCE,7) , SETOR
;
-- ONTEM - SETOR   ONTEM - SETOR   ONTEM - SETOR   ONTEM - SETOR   ONTEM - SETOR   ONTEM - SETOR   ONTEM - SETOR    

SELECT LEFT(DATA_ENCE,7) REF, SETOR,
SUM(INPS) AS INPS_TT,
SUM(TOI) AS TOI_TT, 
 SUM(F100) AS F100_TT, SUM(F200) AS F200_TT,  
 SUM(QTD_FAT) AS QTD_FAT_TT,
  SUM(QTD_CAN) AS QTD_CAN_TT,
   SUM(QTD_PEN) AS QTD_PEN_TT,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F100)/SUM(TOI) AS DECIMAL(10,4)) END AS F100_TOI_TT, 
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F200)/SUM(TOI) AS DECIMAL(10,4)) END AS F200_TOI_TT, 
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(TOI)/SUM(INPS) AS DECIMAL(10,4)) END AS PROC_TT, 
CASE WHEN (SUM(CASE WHEN (USERCODE IN('VNRE','VREL')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(((SUM(VNRE))/(SUM(CASE WHEN (USERCODE IN

('VNRE','VREL')) THEN 1 ELSE 0 END))) AS DECIMAL (10,4))) END AS IMPI_TT,
CAST((((SUM(CASE WHEN DADOS.STATUS IN ('AGUARDANDO_LAUDO','SEM_FATURAR') THEN 1 ELSE 0 END))*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE 

WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END)*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM

(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END))/(SUM(TOI))) AS DECIMAL(10,2)) ) END))/1000) 

AS DECIMAL(10,2)) AS ENERGIA_PROJ,
CAST((SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/1000) AS DECIMAL(10,2)) AS MWH_TT, 
CAST((sum(agreg)/1000) AS DECIMAL(10,2)) as agreg_MWH_TT ,
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END  

AS KWHTOI_TT, 
CASE WHEN SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)=0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO 

ELSE 0 END)/SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)AS DECIMAL(10,2))) END  AS KWHTOIFAT_TT,

CASE WHEN (SUM(INPS)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/(SUM(INPS))AS DECIMAL(10,2))) 

END AS KWHINSP_TT , 
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 

END))/(SUM(TOI))) AS DECIMAL(10,4)) ) END AS EFET_TT,
CASE WHEN (SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST((SUM(CASE WHEN 

(DADOS.CAUSA < 299 AND DADOS.STATUS IN ('FATURADO')) THEN 1 ELSE 0 END))/(SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') 

THEN 1 ELSE 0 END)) AS DECIMAL(10,4))) END  AS EFET_SEMP_TT,
CASE WHEN (SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(SUM

(CASE WHEN DADOS.STATUS = 'FATURADO' THEN 1 ELSE 0 END)/SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) 

THEN 1 ELSE 0 END) AS DECIMAL(10,4)) ) END AS PERC_FAT_TT

-- TOTAIS - FINAIS

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE 
DATA_ENCE=(CASE WHEN WEEKDAY(ADD_DAYS(CURRENT_DATE,-1))=6 THEN ADD_DAYS(CURRENT_DATE,-3) ELSE ADD_DAYS(CURRENT_DATE,-1) END)
AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') AND GERACAO = 'NS') AS DADOS
left join (select nota , sum(consumo) agreg from "CSR957313"."SIP_EN_AGREGADA" r group by nota ) a
on dados.nota = a.nota
GROUP BY LEFT(DATA_ENCE,7) , SETOR

;
-- ONTEM - DIRECIONADOR   ONTEM - DIRECIONADOR ONTEM - DIRECIONADOR ONTEM - DIRECIONADOR ONTEM - DIRECIONADOR

SELECT LEFT(DATA_ENCE,7) REF, DIRECIONADOR_RESUMIDO,
SUM(INPS) AS INPS_TT,
SUM(TOI) AS TOI_TT, 
 SUM(F100) AS F100_TT, SUM(F200) AS F200_TT,  
 SUM(QTD_FAT) AS QTD_FAT_TT,
  SUM(QTD_CAN) AS QTD_CAN_TT,
   SUM(QTD_PEN) AS QTD_PEN_TT,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F100)/SUM(TOI) AS DECIMAL(10,4)) END AS F100_TOI_TT, 
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F200)/SUM(TOI) AS DECIMAL(10,4)) END AS F200_TOI_TT, 
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(TOI)/SUM(INPS) AS DECIMAL(10,4)) END AS PROC_TT, 
CASE WHEN (SUM(CASE WHEN (USERCODE IN('VNRE','VREL')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(((SUM(VNRE))/(SUM(CASE WHEN (USERCODE IN

('VNRE','VREL')) THEN 1 ELSE 0 END))) AS DECIMAL (10,4))) END AS IMPI_TT,
CAST((((SUM(CASE WHEN DADOS.STATUS IN ('AGUARDANDO_LAUDO','SEM_FATURAR') THEN 1 ELSE 0 END))*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE 

WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END)*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM

(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END))/(SUM(TOI))) AS DECIMAL(10,2)) ) END))/1000) 

AS DECIMAL(10,2)) AS ENERGIA_PROJ,
CAST((SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/1000) AS DECIMAL(10,2)) AS MWH_TT, 
CAST((sum(agreg)/1000) AS DECIMAL(10,2)) as agreg_MWH_TT ,
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END  

AS KWHTOI_TT, 
CASE WHEN SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)=0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO 

ELSE 0 END)/SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)AS DECIMAL(10,2))) END  AS KWHTOIFAT_TT,

CASE WHEN (SUM(INPS)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/(SUM(INPS))AS DECIMAL(10,2))) 

END AS KWHINSP_TT , 
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 

END))/(SUM(TOI))) AS DECIMAL(10,4)) ) END AS EFET_TT,
CASE WHEN (SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST((SUM(CASE WHEN 

(DADOS.CAUSA < 299 AND DADOS.STATUS IN ('FATURADO')) THEN 1 ELSE 0 END))/(SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') 

THEN 1 ELSE 0 END)) AS DECIMAL(10,4))) END  AS EFET_SEMP_TT,
CASE WHEN (SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(SUM

(CASE WHEN DADOS.STATUS = 'FATURADO' THEN 1 ELSE 0 END)/SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) 

THEN 1 ELSE 0 END) AS DECIMAL(10,4)) ) END AS PERC_FAT_TT

-- TOTAIS - FINAIS

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE 
DATA_ENCE=(CASE WHEN WEEKDAY(ADD_DAYS(CURRENT_DATE,-1))=6 THEN ADD_DAYS(CURRENT_DATE,-3) ELSE ADD_DAYS(CURRENT_DATE,-1) END) 


AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') AND GERACAO = 'NS') AS DADOS
left join (select nota , sum(consumo) agreg from "CSR957313"."SIP_EN_AGREGADA" r group by nota ) a
on dados.nota = a.nota
GROUP BY LEFT(DATA_ENCE,7) , DIRECIONADOR_RESUMIDO
;

--  MÊS - DIRECIONADOR   MÊS - DIRECIONADOR    MÊS - DIRECIONADOR    MÊS - DIRECIONADOR    MÊS - DIRECIONADOR   

SELECT LEFT(DATA_ENCE,7) REF, DIRECIONADOR_RESUMIDO,
SUM(INPS) AS INPS_TT,
SUM(TOI) AS TOI_TT, 
 SUM(F100) AS F100_TT, SUM(F200) AS F200_TT,  
 SUM(QTD_FAT) AS QTD_FAT_TT,
  SUM(QTD_CAN) AS QTD_CAN_TT,
   SUM(QTD_PEN) AS QTD_PEN_TT,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F100)/SUM(TOI) AS DECIMAL(10,4)) END AS F100_TOI_TT, 
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F200)/SUM(TOI) AS DECIMAL(10,4)) END AS F200_TOI_TT, 
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(TOI)/SUM(INPS) AS DECIMAL(10,4)) END AS PROC_TT, 
CASE WHEN (SUM(CASE WHEN (USERCODE IN('VNRE','VREL')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(((SUM(VNRE))/(SUM(CASE WHEN (USERCODE IN

('VNRE','VREL')) THEN 1 ELSE 0 END))) AS DECIMAL (10,4))) END AS IMPI_TT,
CAST((((SUM(CASE WHEN DADOS.STATUS IN ('AGUARDANDO_LAUDO','SEM_FATURAR') THEN 1 ELSE 0 END))*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE 

WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END)*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM

(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END))/(SUM(TOI))) AS DECIMAL(10,2)) ) END))/1000) 

AS DECIMAL(10,2)) AS ENERGIA_PROJ,
CAST((SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/1000) AS DECIMAL(10,2)) AS MWH_TT, 
CAST((sum(agreg)/1000) AS DECIMAL(10,2)) as agreg_MWH_TT ,
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END  

AS KWHTOI_TT, 
CASE WHEN SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)=0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO 

ELSE 0 END)/SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)AS DECIMAL(10,2))) END  AS KWHTOIFAT_TT,

CASE WHEN (SUM(INPS)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/(SUM(INPS))AS DECIMAL(10,2))) 

END AS KWHINSP_TT , 
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 

END))/(SUM(TOI))) AS DECIMAL(10,4)) ) END AS EFET_TT,
CASE WHEN (SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST((SUM(CASE WHEN 

(DADOS.CAUSA < 299 AND DADOS.STATUS IN ('FATURADO')) THEN 1 ELSE 0 END))/(SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') 

THEN 1 ELSE 0 END)) AS DECIMAL(10,4))) END  AS EFET_SEMP_TT,
CASE WHEN (SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(SUM

(CASE WHEN DADOS.STATUS = 'FATURADO' THEN 1 ELSE 0 END)/SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) 

THEN 1 ELSE 0 END) AS DECIMAL(10,4)) ) END AS PERC_FAT_TT

-- TOTAIS - FINAIS

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE 
LEFT(DATA_ENCE,4) = LEFT(CURRENT_DATE,4)


AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') AND GERACAO = 'NS') AS DADOS
left join (select nota , sum(consumo) agreg from "CSR957313"."SIP_EN_AGREGADA" r group by nota ) a
on dados.nota = a.nota
GROUP BY LEFT(DATA_ENCE,7) , DIRECIONADOR_RESUMIDO
ORDER BY DIRECIONADOR_RESUMIDO, LEFT(DATA_ENCE,7)

;
--  MIX OCLE MÊS/MÊS   -  MIX OCLE MÊS/MÊS   -  MIX OCLE MÊS/MÊS   -  MIX OCLE MÊS/MÊS   - 

SELECT REF,
SUM(INPS) AS INPS_TT,
SUM(CASE WHEN DIRECIONADOR_RESUMIDO = 'OCLE' AND INPS = '1' THEN 1 ELSE 0 END) AS OCLE, 
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(CASE WHEN DIRECIONADOR_RESUMIDO = 'OCLE' AND INPS = '1' THEN 1 ELSE 0 END)/SUM(INPS) AS DECIMAL(10,4)) END AS P_OCLE,
SUM(CASE WHEN DIRECIONADOR_RESUMIDO = 'PROTECAO A RECEITA' AND INPS = '1' THEN 1 ELSE 0 END) AS PROT,
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(CASE WHEN DIRECIONADOR_RESUMIDO = 'PROTECAO A RECEITA' AND INPS = '1' THEN 1 ELSE 0 END)/SUM(INPS) AS DECIMAL(10,4)) END AS P_PROT,
SUM(CASE WHEN DIRECIONADOR_RESUMIDO = 'ANALISE DE CONSUMO' AND INPS = '1' THEN 1 ELSE 0 END) AS ANCO,
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(CASE WHEN DIRECIONADOR_RESUMIDO = 'ANALISE DE CONSUMO' AND INPS = '1' THEN 1 ELSE 0 END)/SUM(INPS) AS DECIMAL(10,4)) END AS P_ANCO,
SUM(CASE WHEN DIRECIONADOR_RESUMIDO NOT IN ( 'OCLE','PROTECAO A RECEITA','ANALISE DE CONSUMO' ) AND INPS = '1' THEN 1 ELSE 0 END) AS OUTROS, 
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(CASE WHEN DIRECIONADOR_RESUMIDO NOT IN ( 'OCLE','PROTECAO A RECEITA','ANALISE DE CONSUMO' ) AND INPS = '1' THEN 1 ELSE 0 END)/SUM(INPS) AS DECIMAL(10,4)) END AS P_OUTROS,
SUM(TOI) AS TOI_TT
-- TOTAIS - FINAIS

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') AND GERACAO = 'NS' AND DATA_ENCE >= '2018-01-01') AS DADOS
left join (select nota , sum(consumo) agreg from "CSR957313"."SIP_EN_AGREGADA" r group by nota ) a
on dados.nota = a.nota
GROUP BY REF
;

--  ANO - DIRECIONADOR    ANO - DIRECIONADOR     ANO - DIRECIONADOR     ANO - DIRECIONADOR     ANO - DIRECIONADOR   

SELECT LEFT(DATA_ENCE,4) REF, 
CASE
WHEN DIRECIONADOR_RESUMIDO = 'OCLE' THEN 'OCLE'
WHEN DIRECIONADOR_RESUMIDO = 'PROTECAO A RECEITA' THEN 'PROTECAO A RECEITA'
WHEN DIRECIONADOR_RESUMIDO = 'ANALISE DE CONSUMO' THEN 'ANALISE DE CONSUMO'
ELSE 'OUTROS' END DIRECIONADOR
,
SUM(INPS) AS INPS_TT,
SUM(TOI) AS TOI_TT, 
 SUM(F100) AS F100_TT, SUM(F200) AS F200_TT,  
 SUM(QTD_FAT) AS QTD_FAT_TT,
  SUM(QTD_CAN) AS QTD_CAN_TT,
   SUM(QTD_PEN) AS QTD_PEN_TT,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F100)/SUM(TOI) AS DECIMAL(10,4)) END AS F100_TOI_TT, 
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F200)/SUM(TOI) AS DECIMAL(10,4)) END AS F200_TOI_TT, 
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(TOI)/SUM(INPS) AS DECIMAL(10,4)) END AS PROC_TT, 
CASE WHEN (SUM(CASE WHEN (USERCODE IN('VNRE','VREL')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(((SUM(VNRE))/(SUM(CASE WHEN (USERCODE IN

('VNRE','VREL')) THEN 1 ELSE 0 END))) AS DECIMAL (10,4))) END AS IMPI_TT,
CAST((((SUM(CASE WHEN DADOS.STATUS IN ('AGUARDANDO_LAUDO','SEM_FATURAR') THEN 1 ELSE 0 END))*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE 

WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END)*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM

(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END))/(SUM(TOI))) AS DECIMAL(10,2)) ) END))/1000) 

AS DECIMAL(10,2)) AS ENERGIA_PROJ,
CAST((SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/1000) AS DECIMAL(10,2)) AS MWH_TT, 
CAST((sum(agreg)/1000) AS DECIMAL(10,2)) as agreg_MWH_TT ,
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END  

AS KWHTOI_TT, 
CASE WHEN SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)=0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO 

ELSE 0 END)/SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)AS DECIMAL(10,2))) END  AS KWHTOIFAT_TT,

CASE WHEN (SUM(INPS)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/(SUM(INPS))AS DECIMAL(10,2))) 

END AS KWHINSP_TT , 
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 

END))/(SUM(TOI))) AS DECIMAL(10,4)) ) END AS EFET_TT,
CASE WHEN (SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST((SUM(CASE WHEN 

(DADOS.CAUSA < 299 AND DADOS.STATUS IN ('FATURADO')) THEN 1 ELSE 0 END))/(SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') 

THEN 1 ELSE 0 END)) AS DECIMAL(10,4))) END  AS EFET_SEMP_TT,
CASE WHEN (SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(SUM

(CASE WHEN DADOS.STATUS = 'FATURADO' THEN 1 ELSE 0 END)/SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) 

THEN 1 ELSE 0 END) AS DECIMAL(10,4)) ) END AS PERC_FAT_TT

-- TOTAIS - FINAIS

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE 
LEFT(DATA_ENCE,4) >= '2019'


AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') AND GERACAO = 'NS') AS DADOS
left join (select nota , sum(consumo) agreg from "CSR957313"."SIP_EN_AGREGADA" r group by nota ) a
on dados.nota = a.nota
GROUP BY LEFT(DATA_ENCE,4) , CASE
WHEN DIRECIONADOR_RESUMIDO = 'OCLE' THEN 'OCLE'
WHEN DIRECIONADOR_RESUMIDO = 'PROTECAO A RECEITA' THEN 'PROTECAO A RECEITA'
WHEN DIRECIONADOR_RESUMIDO = 'ANALISE DE CONSUMO' THEN 'ANALISE DE CONSUMO'
ELSE 'OUTROS' END
ORDER BY CASE
WHEN DIRECIONADOR_RESUMIDO = 'OCLE' THEN 'OCLE'
WHEN DIRECIONADOR_RESUMIDO = 'PROTECAO A RECEITA' THEN 'PROTECAO A RECEITA'
WHEN DIRECIONADOR_RESUMIDO = 'ANALISE DE CONSUMO' THEN 'ANALISE DE CONSUMO'
ELSE 'OUTROS' END, LEFT(DATA_ENCE,4)

;
--   MIX OCLE DIA/DIA   -    MIX OCLE DIA/DIA   -    MIX OCLE DIA/DIA   -    MIX OCLE DIA/DIA   - 

SELECT DATA_ENCE,
SUM(INPS) AS INPS_TT,
SUM(CASE WHEN DIRECIONADOR_RESUMIDO = 'OCLE' AND INPS = '1' THEN 1 ELSE 0 END) AS OCLE, 
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(CASE WHEN DIRECIONADOR_RESUMIDO = 'OCLE' AND INPS = '1' THEN 1 ELSE 0 END)/SUM(INPS) AS DECIMAL(10,4)) END AS P_OCLE,
SUM(CASE WHEN DIRECIONADOR_RESUMIDO = 'PROTECAO A RECEITA' AND INPS = '1' THEN 1 ELSE 0 END) AS PROT,
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(CASE WHEN DIRECIONADOR_RESUMIDO = 'PROTECAO A RECEITA' AND INPS = '1' THEN 1 ELSE 0 END)/SUM(INPS) AS DECIMAL(10,4)) END AS P_PROT,
SUM(CASE WHEN DIRECIONADOR_RESUMIDO = 'ANALISE DE CONSUMO' AND INPS = '1' THEN 1 ELSE 0 END) AS ANCO,
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(CASE WHEN DIRECIONADOR_RESUMIDO = 'ANALISE DE CONSUMO' AND INPS = '1' THEN 1 ELSE 0 END)/SUM(INPS) AS DECIMAL(10,4)) END AS P_ANCO,
SUM(CASE WHEN DIRECIONADOR_RESUMIDO NOT IN ( 'OCLE','PROTECAO A RECEITA','ANALISE DE CONSUMO' ) AND INPS = '1' THEN 1 ELSE 0 END) AS OUTROS, 
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(CASE WHEN DIRECIONADOR_RESUMIDO NOT IN ( 'OCLE','PROTECAO A RECEITA','ANALISE DE CONSUMO' ) AND INPS = '1' THEN 1 ELSE 0 END)/SUM(INPS) AS DECIMAL(10,4)) END AS P_OUTROS,
SUM(TOI) AS TOI_TT

-- TOTAIS - FINAIS

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') AND GERACAO = 'NS' AND DATA_ENCE >= '2019-09-01' ) AS DADOS
left join (select nota , sum(consumo) agreg from "CSR957313"."SIP_EN_AGREGADA" r group by nota ) a
on dados.nota = a.nota
GROUP BY DATA_ENCE
ORDER BY DATA_ENCE

;

--  MES A MES - EQUIPE    MES A MES - EQUIPE    MES A MES - EQUIPE    MES A MES - EQUIPE  

SELECT LEFT(DATA_ENCE,7) REF, CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END EQUIPE,
SUM(INPS) AS INPS_TT,
SUM(TOI) AS TOI_TT, 
 SUM(F100) AS F100_TT, SUM(F200) AS F200_TT,  
 SUM(QTD_FAT) AS QTD_FAT_TT,
  SUM(QTD_CAN) AS QTD_CAN_TT,
   SUM(QTD_PEN) AS QTD_PEN_TT,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F100)/SUM(TOI) AS DECIMAL(10,4)) END AS F100_TOI_TT, 
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F200)/SUM(TOI) AS DECIMAL(10,4)) END AS F200_TOI_TT, 
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(TOI)/SUM(INPS) AS DECIMAL(10,4)) END AS PROC_TT, 
CASE WHEN (SUM(CASE WHEN (USERCODE IN('VNRE','VREL')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(((SUM(VNRE))/(SUM(CASE WHEN (USERCODE IN

('VNRE','VREL')) THEN 1 ELSE 0 END))) AS DECIMAL (10,4))) END AS IMPI_TT,
CAST((((SUM(CASE WHEN DADOS.STATUS IN ('AGUARDANDO_LAUDO','SEM_FATURAR') THEN 1 ELSE 0 END))*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE 

WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END)*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM

(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END))/(SUM(TOI))) AS DECIMAL(10,2)) ) END))/1000) 

AS DECIMAL(10,2)) AS ENERGIA_PROJ,
CAST((SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/1000) AS DECIMAL(10,2)) AS MWH_TT, 
CAST((sum(agreg)/1000) AS DECIMAL(10,2)) as agreg_MWH_TT ,
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END  

AS KWHTOI_TT, 
CASE WHEN SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)=0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO 

ELSE 0 END)/SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)AS DECIMAL(10,2))) END  AS KWHTOIFAT_TT,

CASE WHEN (SUM(INPS)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/(SUM(INPS))AS DECIMAL(10,2))) 

END AS KWHINSP_TT , 
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 

END))/(SUM(TOI))) AS DECIMAL(10,4)) ) END AS EFET_TT,
CASE WHEN (SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST((SUM(CASE WHEN 

(DADOS.CAUSA < 299 AND DADOS.STATUS IN ('FATURADO')) THEN 1 ELSE 0 END))/(SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') 

THEN 1 ELSE 0 END)) AS DECIMAL(10,4))) END  AS EFET_SEMP_TT,
CASE WHEN (SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(SUM

(CASE WHEN DADOS.STATUS = 'FATURADO' THEN 1 ELSE 0 END)/SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) 

THEN 1 ELSE 0 END) AS DECIMAL(10,4)) ) END AS PERC_FAT_TT

-- TOTAIS - FINAIS

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE LEFT(DATA_ENCE,4)= LEFT(CURRENT_DATE,4) AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') AND GERACAO = 

'NS') AS DADOS
left join (select nota , sum(consumo) agreg from "CSR957313"."SIP_EN_AGREGADA" r group by nota ) a
on dados.nota = a.nota
GROUP BY LEFT(DATA_ENCE,7) , CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END 
ORDER BY CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END , LEFT(DATA_ENCE,7)

;

--  DIA A DIA - EQUIPE    DIA A DIA - EQUIPE    DIA A DIA - EQUIPE    DIA A DIA - EQUIPE  

SELECT DATA_ENCE REF, CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END EQUIPE,
SUM(INPS) AS INPS_TT,
SUM(TOI) AS TOI_TT, 
 SUM(F100) AS F100_TT, SUM(F200) AS F200_TT,  
 SUM(QTD_FAT) AS QTD_FAT_TT,
  SUM(QTD_CAN) AS QTD_CAN_TT,
   SUM(QTD_PEN) AS QTD_PEN_TT,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F100)/SUM(TOI) AS DECIMAL(10,4)) END AS F100_TOI_TT, 
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F200)/SUM(TOI) AS DECIMAL(10,4)) END AS F200_TOI_TT, 
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(TOI)/SUM(INPS) AS DECIMAL(10,4)) END AS PROC_TT, 
CASE WHEN (SUM(CASE WHEN (USERCODE IN('VNRE','VREL')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(((SUM(VNRE))/(SUM(CASE WHEN (USERCODE IN

('VNRE','VREL')) THEN 1 ELSE 0 END))) AS DECIMAL (10,4))) END AS IMPI_TT,
CAST((((SUM(CASE WHEN DADOS.STATUS IN ('AGUARDANDO_LAUDO','SEM_FATURAR') THEN 1 ELSE 0 END))*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE 

WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END)*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM

(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END))/(SUM(TOI))) AS DECIMAL(10,2)) ) END))/1000) 

AS DECIMAL(10,2)) AS ENERGIA_PROJ,
CAST((SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/1000) AS DECIMAL(10,2)) AS MWH_TT, 
CAST((sum(agreg)/1000) AS DECIMAL(10,2)) as agreg_MWH_TT ,
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END  

AS KWHTOI_TT, 
CASE WHEN SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)=0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO 

ELSE 0 END)/SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)AS DECIMAL(10,2))) END  AS KWHTOIFAT_TT,

CASE WHEN (SUM(INPS)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/(SUM(INPS))AS DECIMAL(10,2))) 

END AS KWHINSP_TT , 
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 

END))/(SUM(TOI))) AS DECIMAL(10,4)) ) END AS EFET_TT,
CASE WHEN (SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST((SUM(CASE WHEN 

(DADOS.CAUSA < 299 AND DADOS.STATUS IN ('FATURADO')) THEN 1 ELSE 0 END))/(SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') 

THEN 1 ELSE 0 END)) AS DECIMAL(10,4))) END  AS EFET_SEMP_TT,
CASE WHEN (SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(SUM

(CASE WHEN DADOS.STATUS = 'FATURADO' THEN 1 ELSE 0 END)/SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) 

THEN 1 ELSE 0 END) AS DECIMAL(10,4)) ) END AS PERC_FAT_TT

-- TOTAIS - FINAIS

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE LEFT(DATA_ENCE,7)= LEFT(CURRENT_DATE,7) AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') AND GERACAO = 

'NS') AS DADOS
left join (select nota , sum(consumo) agreg from "CSR957313"."SIP_EN_AGREGADA" r group by nota ) a
on dados.nota = a.nota
GROUP BY DATA_ENCE, CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END 
ORDER BY CASE WHEN EQUIPE in ('CELPE','COELBA','COSERN') THEN 'BPROPRIO' ELSE 'BEPS'  END, DATA_ENCE


;

--  MES A MES - EQUIPE    MES A MES - EQUIPE    MES A MES - EQUIPE    MES A MES - EQUIPE  

SELECT LEFT(DATA_ENCE,7) REF,
SUM(INPS) AS INPS_TT,
SUM(TOI) AS TOI_TT, 
 SUM(F100) AS F100_TT, SUM(F200) AS F200_TT,  
 SUM(QTD_FAT) AS QTD_FAT_TT,
  SUM(QTD_CAN) AS QTD_CAN_TT,
   SUM(QTD_PEN) AS QTD_PEN_TT,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F100)/SUM(TOI) AS DECIMAL(10,4)) END AS F100_TOI_TT, 
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(F200)/SUM(TOI) AS DECIMAL(10,4)) END AS F200_TOI_TT, 
CASE WHEN SUM(INPS) = 0 THEN 0 ELSE CAST(SUM(TOI)/SUM(INPS) AS DECIMAL(10,4)) END AS PROC_TT, 
CASE WHEN (SUM(CASE WHEN (USERCODE IN('VNRE','VREL')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(((SUM(VNRE))/(SUM(CASE WHEN (USERCODE IN

('VNRE','VREL')) THEN 1 ELSE 0 END))) AS DECIMAL (10,4))) END AS IMPI_TT,
CAST((((SUM(CASE WHEN DADOS.STATUS IN ('AGUARDANDO_LAUDO','SEM_FATURAR') THEN 1 ELSE 0 END))*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE 

WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END)*(CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM

(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END))/(SUM(TOI))) AS DECIMAL(10,2)) ) END))/1000) 

AS DECIMAL(10,2)) AS ENERGIA_PROJ,
CAST((SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/1000) AS DECIMAL(10,2)) AS MWH_TT, 
CAST((sum(agreg)/1000) AS DECIMAL(10,2)) as agreg_MWH_TT ,
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/SUM(TOI)AS DECIMAL(10,2))) END  

AS KWHTOI_TT, 
CASE WHEN SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)=0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO 

ELSE 0 END)/SUM(CASE WHEN KWH_RECUPERADO > 0 THEN TOI ELSE 0 END)AS DECIMAL(10,2))) END  AS KWHTOIFAT_TT,

CASE WHEN (SUM(INPS)) = 0 THEN 0 ELSE (CAST(SUM(CASE WHEN DADOS.CAUSA IS NOT NULL THEN KWH_RECUPERADO ELSE 0 END)/(SUM(INPS))AS DECIMAL(10,2))) 

END AS KWHINSP_TT , 
CASE WHEN (SUM(TOI)) = 0 THEN 0 ELSE (CAST((1-(SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 

END))/(SUM(TOI))) AS DECIMAL(10,4)) ) END AS EFET_TT,
CASE WHEN (SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST((SUM(CASE WHEN 

(DADOS.CAUSA < 299 AND DADOS.STATUS IN ('FATURADO')) THEN 1 ELSE 0 END))/(SUM(CASE WHEN DADOS.STATUS IN ('FATURADO','CANCELADO','SEM_COBRANCA') 

THEN 1 ELSE 0 END)) AS DECIMAL(10,4))) END  AS EFET_SEMP_TT,
CASE WHEN (SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) THEN 1 ELSE 0 END)) = 0 THEN 0 ELSE (CAST(SUM

(CASE WHEN DADOS.STATUS = 'FATURADO' THEN 1 ELSE 0 END)/SUM(CASE WHEN (DADOS.CAUSA < 299 AND DADOS.STATUS NOT IN ('CANCELADO','SEM_COBRANCA')) 

THEN 1 ELSE 0 END) AS DECIMAL(10,4)) ) END AS PERC_FAT_TT

-- TOTAIS - FINAIS

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE LEFT(DATA_ENCE,4)> '2018' AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') AND GERACAO = 

'NS') AS DADOS
left join (select nota , sum(consumo) agreg from "CSR957313"."SIP_EN_AGREGADA" r group by nota ) a
on dados.nota = a.nota
GROUP BY LEFT(DATA_ENCE,7)
ORDER BY LEFT(DATA_ENCE,7)

;

SELECT DATA_ENCE,
SUM(INPS) AS INPS_TT,
SUM(CASE WHEN FAMILIA = '100' AND INPS = '1' THEN 1 ELSE 0 END) AS F100, 
SUM(CASE WHEN FAMILIA = '100' AND INPS = '1' AND CAUSA IN ('103','106','107','201','202','210') THEN 1 ELSE 0 END) AS F100_AFE, 
SUM(CASE WHEN FAMILIA = '200' AND INPS = '1' THEN 1 ELSE 0 END) AS F200, 
SUM(CASE WHEN FAMILIA = '200' AND INPS = '1' AND CAUSA IN ('103','106','107','201','202','210') THEN 1 ELSE 0 END) AS F200_AFE, 
SUM(CASE WHEN CAUSA IN ('103','106','107','201','202','210') AND INPS = '1' THEN 1 ELSE 0 END) AS AFERICAO, 
SUM(TOI) AS TOI_TT

-- TOTAIS - FINAIS

FROM (SELECT * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE  DATA_ENCE >= '2020-01-01' ) AS DADOS
left join (select nota , sum(consumo) agreg from "CSR957313"."SIP_EN_AGREGADA" r group by nota ) a
on dados.nota = a.nota
GROUP BY DATA_ENCE
ORDER BY DATA_ENCE

;

SELECT --SETOR,UTD , 
LEFT(ERDAT,7) FAT,
SUM(TOI) AS TOI_TT, 
 SUM(KWH_RECUPERADO) KWHR,
CASE WHEN SUM(TOI) = 0 THEN 0 ELSE CAST(SUM(KWH_RECUPERADO)/SUM(TOI) AS DECIMAL(10,4)) END AS KWHR_TOI,
COUNT( DISTINCT ERDAT) DD,
SUM(TOI)/COUNT( DISTINCT ERDAT) FAT_DIA
-- TOTAIS - FINAIS

FROM (SELECT  * FROM "CLP124051"."PLANILHAO_NOTA_CI" WHERE LEFT(ERDAT,4) > '2018'  AND GRUPO IN ('GRUPO_B_SEM_IP','IP_MEDIDA') ) AS DADOS

GROUP BY LEFT(ERDAT,7)
ORDER BY LEFT(ERDAT,7)

