--ENERGIA PERDIDA V 8
SELECT NOTA, ANLAGE, ZCGNOMCLI, MUNICIPIO, DIRECIONADOR, ENERGIA_PREV, ZCGSITUCC, ZCGTARTYP, GRUPO_CPSP, GERACAO, UTD, TEXTONOTA, USERCODE, DATACRIACAO, MED_ANT, MEDIA_12M, QUEDA, QUEDA_FINAL, ENERGIA_IRR, ENERGIA_DEF, SCORE_TEMPO, SCORE_CRITERIO, SCORE_ENERGIA, PORTECLI, ENERGIA_PERDIDA, ORDEM FROM 
(
SELECT*, RANK() OVER(PARTITION BY utd ORDER BY UTD,SCORE_TEMPO, score_criterio, score_energia, ENERGIA_PREV DESC, ANLAGE) AS ORDEM
FROM (SELECT ANLAGE, ZCGSITUCC, ZCGTARTYP, ZCGNOMCLI, GRUPO_CPSP, GERACAO, UTD , MUNICIPIO, NOTA, TEXTONOTA, USERCODE, DATACRIACAO, ROUND(MED_ANT,2) AS MED_ANT, ROUND(MED12M,2) AS MEDIA_12M, QUEDA, QUEDA_FINAL, ROUND("Energia_irr",2) AS ENERGIA_IRR, ROUND("Energia_def",2) AS ENERGIA_DEF,  

--TEMPO
CASE  
WHEN QUEDA_FINAL > 3 THEN 0 
WHEN QUEDA_FINAL = 3 THEN 1 
WHEN QUEDA_FINAL < 3 THEN 2 
ELSE NULL END AS SCORE_TEMPO,

--CRITERIO
CASE WHEN 
(UPPER(TEXTONOTA) LIKE UPPER('%DESP%') OR UPPER(TEXTONOTA) LIKE UPPER('%ZERO%') OR UPPER(TEXTONOTA) LIKE UPPER('%DANI%') OR UPPER(TEXTONOTA) LIKE UPPER('%TP%') OR UPPER(TEXTONOTA) LIKE UPPER('%TC%') OR UPPER(TEXTONOTA) LIKE UPPER('%BY%') OR UPPER(TEXTONOTA) LIKE UPPER('%DESP%') OR UPPER(TEXTONOTA) LIKE UPPER('%SUBS%') OR 
UPPER(TEXTONOTA) LIKE UPPER('%D4#%') OR 
UPPER(TEXTONOTA) LIKE UPPER('%D5#%')) THEN 0 ELSE 1
END AS SCORE_CRITERIO,

--CRIT ENERGIA
CASE 
WHEN ((CASE WHEN ("Energia_irr" IS NOT NULL) THEN ROUND("Energia_irr",2) ELSE (CASE WHEN (QUEDA IS NULL OR QUEDA = 0) THEN ROUND(MED12M,2) WHEN QUEDA > 0 THEN ROUND((MED_ANT), 2) ELSE 0 END) END) <= FX1) THEN 2
WHEN ((CASE WHEN ("Energia_irr" IS NOT NULL) THEN ROUND("Energia_irr",2) ELSE (CASE WHEN (QUEDA IS NULL OR QUEDA = 0) THEN ROUND(MED12M,2) WHEN QUEDA > 0 THEN ROUND((MED_ANT), 2) ELSE 0 END) END) BETWEEN FX1 AND FX2) THEN 1
WHEN ((CASE WHEN ("Energia_irr" IS NOT NULL) THEN ROUND("Energia_irr",2) ELSE (CASE WHEN (QUEDA IS NULL OR QUEDA = 0) THEN ROUND(MED12M,2) WHEN QUEDA > 0 THEN ROUND((MED_ANT), 2) ELSE 0 END) END) >= FX2) THEN 0
END AS SCORE_ENERGIA,

--DIRECIONADOR
CASE 
WHEN UPPER(TEXTONOTA) LIKE UPPER('%D1#%') THEN 'ALARMES'
WHEN UPPER(TEXTONOTA) LIKE UPPER('%D2#%') THEN 'ANALISE DE CONSUMO'
WHEN UPPER(TEXTONOTA) LIKE UPPER('%D3#%') THEN 'ANALISE DE CONSTANTE'
WHEN UPPER(TEXTONOTA) LIKE UPPER('%D4#%') THEN 'DENUNCIA DE PLANTAO - NDS'
WHEN UPPER(TEXTONOTA) LIKE UPPER('%D5#%') THEN 'OCORRENCIA DE LEITURA - OCLE'
WHEN UPPER(TEXTONOTA) LIKE UPPER('%D6#%') THEN 'TEMPO DE INSPECAO'
WHEN UPPER(TEXTONOTA) LIKE UPPER('%D7#%') THEN 'SOLICITACAO EXTERNA - UTD_CCO'
WHEN UPPER(TEXTONOTA) LIKE UPPER('%D8#%') THEN 'PARAMETROS DO MEDIDOR'
WHEN UPPER(TEXTONOTA) LIKE UPPER('%D9#%') THEN 'LIGACAO NOVA' 
WHEN UPPER(TEXTONOTA) LIKE UPPER('%D14#%') THEN 'CLASSIFICACAO ESTATISTICA' 
WHEN UPPER(TEXTONOTA) LIKE UPPER('%D16#%') THEN 'ANALISE POR ALIMENTADOR' 
WHEN UPPER(TEXTONOTA) LIKE UPPER('%D17#%') THEN 'ANALISE DA DEMANDA CONTRATADA' 
WHEN UPPER(TEXTONOTA) LIKE UPPER('%D18#%') THEN 'MEDICAO COM TP - CUBICULO DE MEDICAO' 
WHEN UPPER(TEXTONOTA) LIKE UPPER('%D19#%') THEN 'ALGORITMO DE QUEDA NO CONSUMO' 
WHEN UPPER(TEXTONOTA) LIKE UPPER('%D20#%') THEN 'AVALIACAO - CONSUMO PONTA/FORA'  
ELSE 'OUTROS' END AS DIRECIONADOR,

--PORTE
CASE 
WHEN (QUEDA IS NULL OR QUEDA = 0) THEN ROUND(MED12M,2)
WHEN QUEDA > 0 THEN ROUND((MED_ANT), 2)
ELSE 0 END AS PORTECLI, 

--ENERGIA_PERDIDA
CASE 
WHEN (QUEDA_FINAL IS NULL OR QUEDA_FINAL = 0) THEN 0
WHEN QUEDA_FINAL <= 3 THEN 0
WHEN QUEDA_FINAL > 3 AND ("Energia_irr" IS NOT NULL AND "Energia_def" IS NOT NULL) THEN ROUND(("Energia_irr" - "Energia_def") ,2)
ELSE 0 END AS ENERGIA_PERDIDA,

--ENERGIA_PREV
CASE WHEN ("Energia_irr" IS NOT NULL AND "Energia_irr" > 0) THEN ROUND("Energia_irr",2) ELSE (CASE WHEN (QUEDA IS NULL OR QUEDA = 0) THEN ROUND(MED12M,2) WHEN QUEDA > 0 THEN ROUND((MED_ANT), 2) ELSE 0 END) END
AS ENERGIA_PREV

FROM (SELECT *, CASE WHEN ENE.QUEDA IS NOT NULL THEN ENE.QUEDA WHEN ENE.QUEDA IS NULL AND MESES_NOTA IS NOT NULL THEN MESES_NOTA END AS QUEDA_FINAL FROM "CLP123432"."ENERGIA_TOTAL" ENE
LEFT JOIN (SELECT INSTALACAO, NOTA, USERCODE, DATACRIACAO, GERACAO, ROUND(DAYS_BETWEEN(DATACRIACAO,CURRENT_DATE)/30,0) AS MESES_NOTA, DAYS_BETWEEN(DATACRIACAO,CURRENT_DATE) AS DIAS_NOTA, TEXTONOTA, DATA_ENCE FROM "CLP123432"."PLANILHAO_NOTA_CI" WHERE DATA_ENCE ='1900-01-01' AND  USERCODE in ('CRIA','DESP','RETI','CRRE','REDI')) PCI ON ENE.ANLAGE = INSTALACAO
LEFT JOIN (SELECT * FROM (SELECT ZCGINSTAL, ZCGACCOUN, ZCGSITUCC, ZCGTARTYP, ZCGNOMCLI, UTD, MUNICIPIO, GRUPO_CPSP, ROW_NUMBER() OVER(PARTITION BY ZCGINSTAL ORDER BY ZCGACCOUN DESC) AS SEQ_INST FROM "CLP123432"."PLANILHAO_CLIENTE") WHERE SEQ_INST = 1 AND ( UPPER("ZCGTARTYP") NOT LIKE  UPPER('%L%'))) CLI ON CLI.ZCGINSTAL = ENE.ANLAGE 
LEFT JOIN (SELECT ZCGINSTALL, MED12M FROM "NEO_PEC"."neo.pec.data::MODEL.TABLES.ZCT_ABT_PROD") ABT ON ZCGINSTALL = ANLAGE
LEFT JOIN "CLP123432"."APOIO_FAIXAS_ENERGIAPERDIDA" FX ON UTD = DESC_UTD
LEFT JOIN "CLP123432"."PLANILHAO_INELEGIVEIS" INEL ON INEL.ZCGINSTAL = ANLAGE)

WHERE NOTA IS NOT NULL AND GRUPO_CPSP = 'GRUPO_A' AND ZCGTARTYP NOT LIKE '%L%' --AND (TEXTONOTA like '%D1#%' OR TEXTONOTA LIKE '%D4%' OR TEXTONOTA LIKE '%D5%')

)
ORDER BY UTD, SCORE_TEMPO, SCORE_CRITERIO, SCORE_ENERGIA, ENERGIA_PREV DESC

)
WHERE ORDEM <= 10
