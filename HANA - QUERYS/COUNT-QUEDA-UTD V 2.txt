--CONTA O QUE TEM QUEDA (ENERGIA_TOTAL) FILTRO: GRUPO_A, LIGADO, NÃƒO LIVRE, SEM NOTA

SELECT UTD,
COUNT (*) AS CONTADOR

FROM

(select * from  ( SELECT * FROM "CLP123432"."ENERGIA_TOTAL" WHERE "Energia_irr" IS NOT NULL) e
INNER join (SELECT DISTINCT "ZCGINSTAL", "UTD", "ZCGNOMCLI", "GRUPO_CPSP"  FROM "CLP123432"."PLANILHAO_CLIENTE" WHERE ("GRUPO_CPSP" = 'GRUPO_A') AND "ZCGSITUCC" = 'LIGADO'  AND ( UPPER("ZCGTARTYP") NOT LIKE  UPPER('%L%'))) c  
on e.anlage = C.zcginstal

LEFT JOIN (SELECT "INSTALACAO", "NOTA", "DATA_ENCE" FROM "CLP123432"."PLANILHAO_NOTA_CI" WHERE DATA_ENCE ='1900-01-01' AND  USERCODE in ('CRIA','DESP','RETI','CRRE','REDI')) D   
ON e.anlage = D.INSTALACAO

WHERE "Energia_irr" > 0 AND NOTA IS NULL
order by "Energia_irr" desc
)
GROUP BY UTD
order by "UTD"

