-- PRIORIDADE GRUPO B - METROPOLITANO

SELECT *
FROM
(
(
SELECT 
SETOR, UTD, MUNICIPIO, NOTA, USERCODE, ZCGSYSSTS, CASE WHEN EQUIPE = 'CELPE' THEN 'BPROPRIO' ELSE 'BEPS'  END EQUIPE, INSTALACAO, ZCGCDCODE, TEXTONOTA, 
CASE
WHEN ( UPPER("TEXTONOTA") LIKE  UPPER('%NDS%')) THEN 'NDS'
WHEN ( UPPER("TEXTONOTA") LIKE  UPPER('%DENU%')) THEN 'DENU'
WHEN ( UPPER("TEXTONOTA") LIKE  UPPER('%OCLE%')) THEN 'OCLE'
WHEN ( UPPER("TEXTONOTA") LIKE  UPPER('%O_LEITURA%')) THEN 'OCLE'
WHEN ( UPPER("ZCGCDCODE") LIKE  UPPER('%OCLE%')) THEN 'OCLE'
WHEN ( UPPER("TEXTONOTA") LIKE  UPPER('%SABV%')) AND ( UPPER("TEXTONOTA") LIKE  UPPER('%D1#%')) THEN 'ALARME'
ELSE 'OUTROS' END AS ACERTO_F2,
GRUPO, CRIADO, ENERG_PREV_IRR, ENERG_PREV_DEF,
CASE WHEN LEFT(NOTA,4)='0044' THEN 'CI' ELSE 'CM' END AS TIPO,
CASE WHEN ENCE >= '2018-01-01' THEN 'X' ELSE '' END NOTA_ANTES
FROM "CLP123432"."PLANILHAO_NOTA_CI"
LEFT JOIN
(SELECT INSTALACAO AS INST, MAX(DATA_ENCE) AS ENCE FROM "CLP123432"."PLANILHAO_NOTA_CI" WHERE FAMILIA IS NOT NULL AND CT <> '1PE000' 
GROUP BY INSTALACAO)
ON INSTALACAO=INST
WHERE USERCODE IN ('CRIA','REDI','RETI','DESP') AND DATA_ENCE = '1900-01-01' AND FAMILIA IS NULL AND GRUPO = 'GRUPO_B_SEM_IP')
UNION ALL
(
SELECT 
SETOR, UTD, MUNICIPIO, NOTA, USERCODE, ZCGSYSSTS, CASE WHEN EQUIPE = 'CELPE' THEN 'BPROPRIO' ELSE 'BEPS'  END EQUIPE, INSTALACAO, ZCGCDCODE, TEXTONOTA, 
CASE
WHEN ( UPPER("TEXTONOTA") LIKE  UPPER('%NDS%')) THEN 'NDS'
WHEN ( UPPER("TEXTONOTA") LIKE  UPPER('%DENU%')) THEN 'DENU'
WHEN ( UPPER("TEXTONOTA") LIKE  UPPER('%OCLE%')) THEN 'OCLE'
WHEN ( UPPER("TEXTONOTA") LIKE  UPPER('%O_LEITURA%')) THEN 'OCLE'
WHEN ( UPPER("ZCGCDCODE") LIKE  UPPER('%OCLE%')) THEN 'OCLE'
WHEN ( UPPER("TEXTONOTA") LIKE  UPPER('%SABV%')) AND ( UPPER("TEXTONOTA") LIKE  UPPER('%D1#%')) THEN 'ALARME'
ELSE 'OUTROS' END AS ACERTO_F2,
GRUPO, CRIADO, '0' AS ENERG_PREV_IRR, '0' AS ENERG_PREV_DEF,
CASE WHEN LEFT(NOTA,4)='0044' THEN 'CI' ELSE 'CM' END AS TIPO,
CASE WHEN ENCE >= '2018-01-01' THEN 'X' ELSE '' END NOTA_ANTES
FROM "CLP123432"."PLANILHAO_NOTA_CM"
LEFT JOIN
(SELECT INSTALACAO AS INST, MAX(DATA_ENCE) AS ENCE FROM "CLP123432"."PLANILHAO_NOTA_CM" WHERE DATA_ENCE>='2018-01-01'
and USERCODE = 'VREL' GROUP BY INSTALACAO)
ON INSTALACAO=INST
WHERE ZCGCDCODE IN ('MSSB','MSYZ') AND USERCODE IN ('CRIA','REDI','RETI','DESP') AND DATA_ENCE = '1900-01-01' AND GRUPO = 'GRUPO_B_SEM_IP'
)
)WHERE ACERTO_F2 IN ('NDS', 'OCLE', 'DENU', 'ALARME') AND
( UPPER("UTD") LIKE  UPPER('%METROPOLITANO%')) AND "TIPO" = 'CI'

ORDER BY UTD, EQUIPE, ACERTO_F2, ENERG_PREV_DEF DESC
